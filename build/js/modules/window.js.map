{"version":3,"names":[],"mappings":"","sources":["modules/window.js"],"sourcesContent":["import { throttle } from './throttle.js';\r\nimport { events, isTouchDevice, deviceType } from './checkDeviceType.js';\r\n\r\nisTouchDevice();\r\n\r\nconst template = document.querySelector('.template');\r\nconst desktop = document.querySelector('.desktop');\r\nconst desktopFooter = desktop.querySelector('.desktop__footer');\r\nconst windowTemplate = template.querySelector('.window');\r\nconst referenceTemplate = template.querySelector('.reference');\r\nlet initialzIndex = 0;\r\nlet initialX = 0;\r\nlet initialY = 0;\r\nlet lastFile;\r\nlet moveElement = false;\r\nlet initialWindowCounterVertical = 0;\r\nlet initialWindowCounterHorisontal = 0;\r\nlet offsetVerticalCounter = 0;\r\nlet offsetHorisontalCounter = 0;\r\nconst desktopWidth = desktop.offsetWidth;\r\nconst desktopHeight = desktop.offsetHeight;\r\nconst halfDesktopWidth = desktopWidth / 2;\r\nconst halfDesktopHeight = desktopHeight / 2;\r\nconst windowWidth = Math.round(window.innerWidth * 0.7);\r\nconst windowHeight = Math.round(window.innerHeight * 0.7);\r\n\r\ndesktopFooter.addEventListener('wheel', (evt) => {\r\n  evt.preventDefault();\r\n  desktopFooter.scrollLeft += evt.deltaY;\r\n});\r\n\r\ndesktop.addEventListener(events[deviceType].click, (evt) => {\r\n  if (evt.target.closest('.file')) {\r\n    onFileOpen(evt);\r\n  }\r\n});\r\n\r\nconst setStartPosition = (elem) => {\r\n  elem.classList.remove('window--collapsed');\r\n  elem.style.left = `${halfDesktopWidth + initialWindowCounterHorisontal}px`;\r\n  elem.style.top = `${halfDesktopHeight + initialWindowCounterVertical}px`;\r\n  elem.style.width = `${windowWidth}px`;\r\n  elem.style.height = `${windowHeight}px`;\r\n  if (initialWindowCounterHorisontal + (desktopWidth - windowWidth) / 2 + 10 + windowWidth >= desktopWidth) {\r\n    initialWindowCounterHorisontal = 0;\r\n    offsetHorisontalCounter = 0;\r\n  } else {\r\n    initialWindowCounterHorisontal += 10;\r\n    offsetHorisontalCounter += 1;\r\n  }\r\n  if (initialWindowCounterVertical + (desktopHeight - windowHeight) / 2 + 30 + windowHeight >= desktopHeight) {\r\n    initialWindowCounterVertical = 0;\r\n    offsetVerticalCounter = 0;\r\n  } else {\r\n    initialWindowCounterVertical += 30;\r\n    offsetVerticalCounter += 1;\r\n  }\r\n};\r\n\r\nfunction onFileOpen(evt) {\r\n  evt.target.classList.remove('file');\r\n  evt.target.classList.add('file--opened');\r\n  const fileLabel = evt.target.querySelector('.file__label');\r\n  const fileName = evt.target.querySelector('.file__name');\r\n  const pathIcon = evt.target.querySelector('.file__icon').cloneNode(true);\r\n  const newWindow = windowTemplate.cloneNode(true);\r\n  const newWindowPath = newWindow.querySelector('.window__path');\r\n  const windowHeader = newWindow.querySelector('.window__header');\r\n  const windowDraggableArea = windowHeader.querySelector('.window__draggable-area');\r\n  const reference = referenceTemplate.cloneNode(true);\r\n\r\n  const clonedTargetContent = evt.target.querySelector('.file__content').cloneNode(true);\r\n  newWindow.appendChild(clonedTargetContent);\r\n  clonedTargetContent.classList.remove('visually-hidden');\r\n  clonedTargetContent.classList.add('window__content');\r\n  clonedTargetContent.classList.remove('file__content');\r\n  if (evt.target.classList.contains('file--folder')) {\r\n    clonedTargetContent.classList.add('window__content--folder');\r\n  }\r\n\r\n  newWindowPath.textContent = fileName.textContent;\r\n  windowDraggableArea.insertBefore(pathIcon, newWindowPath);\r\n  desktop.appendChild(newWindow);\r\n  setStartPosition(newWindow);\r\n  fileLabel.classList.add('file__label--active');\r\n\r\n  const setCurrentWindowActive = () => {\r\n    lastFile = reference;\r\n    const newzIndex = initialzIndex + 1;\r\n    newWindow.style.zIndex = `${newzIndex}`;\r\n    initialzIndex = newzIndex;\r\n    reference.classList.add('reference--active');\r\n    desktop.querySelectorAll('.window--active').forEach((a) => {\r\n      a.classList.remove('window--active');\r\n    });\r\n    newWindow.classList.add('window--active');\r\n    desktop.querySelectorAll('.reference').forEach((b) => {\r\n      if (b === lastFile) {\r\n        b.classList.add('reference--active');\r\n      } else {\r\n        b.classList.remove('reference--active');\r\n      }\r\n    });\r\n  };\r\n\r\n  setCurrentWindowActive();\r\n\r\n  const onMoveEvent = (e) => {\r\n    if (moveElement === true) {\r\n      const newX = !isTouchDevice() ? e.clientX : e.touches[0].clientX;\r\n      const newY = !isTouchDevice() ? e.clientY : e.touches[0].clientY;\r\n      const calcX = initialX - newX;\r\n      const calcY = initialY - newY;\r\n      const leftPosition = `${newWindow.offsetLeft - calcX}px`;\r\n      const topPosition = `${newWindow.offsetTop - calcY}px`;\r\n      newWindow.style.left = leftPosition;\r\n      newWindow.style.top = topPosition;\r\n      initialX = newX;\r\n      initialY = newY;\r\n    }\r\n  };\r\n  const onMoveThrottled = throttle(onMoveEvent, 10);\r\n\r\n  const onMoveStop = () => {\r\n    document.removeEventListener(events[deviceType].move, onMoveThrottled);\r\n    document.removeEventListener(events[deviceType].up, onMoveStop);\r\n    moveElement = false;\r\n  };\r\n\r\n  function onWindowDrag(e) {\r\n    setCurrentWindowActive();\r\n    if (e.cancelable) {\r\n      e.preventDefault();\r\n    }\r\n    if (!newWindow.classList.contains('window--fullscreen')) {\r\n      moveElement = true;\r\n      initialX = !isTouchDevice() ? e.clientX : e.touches[0].clientX;\r\n      initialY = !isTouchDevice() ? e.clientY : e.touches[0].clientY;\r\n      document.addEventListener(events[deviceType].move, onMoveThrottled);\r\n      document.addEventListener(events[deviceType].up, onMoveStop);\r\n    }\r\n  }\r\n\r\n  const onCollapseButton = () => {\r\n    if (newWindow.classList.contains('window--collapsed')) {\r\n      newWindow.classList.remove('window--collapsed');\r\n      setCurrentWindowActive();\r\n    } else {\r\n      if (reference === lastFile) {\r\n        newWindow.classList.add('window--collapsed');\r\n      } else {\r\n        setCurrentWindowActive();\r\n      }\r\n    }\r\n  };\r\n\r\n  const referenceIcon = evt.target.querySelector('.file__icon').cloneNode(true);\r\n  const referenceText = reference.querySelector('.reference__text');\r\n  referenceText.textContent = fileName.textContent;\r\n  reference.insertBefore(referenceIcon, referenceText);\r\n  desktopFooter.appendChild(reference);\r\n  reference.addEventListener(events[deviceType].click, onCollapseButton);\r\n\r\n  const onCloseButton = () => {\r\n    evt.target.classList.add('file');\r\n    evt.target.classList.remove('file--opened');\r\n    setCurrentWindowActive();\r\n    newWindow.remove();\r\n    pathIcon.remove();\r\n    reference.remove();\r\n    clonedTargetContent.remove();\r\n    referenceIcon.remove();\r\n    fileLabel.classList.remove('file__label--active');\r\n    if (offsetVerticalCounter > 0) {\r\n      offsetVerticalCounter -= 1;\r\n      initialWindowCounterVertical -= 30;\r\n    }\r\n    if (offsetHorisontalCounter > 0) {\r\n      offsetHorisontalCounter -= 1;\r\n      initialWindowCounterHorisontal -= 10;\r\n    }\r\n  };\r\n\r\n  const onExpandButton = () => {\r\n    setCurrentWindowActive(reference, newWindow);\r\n    if (newWindow.classList.contains('window--fullscreen')) {\r\n      newWindow.classList.remove('window--fullscreen');\r\n    } else {\r\n      newWindow.classList.add('window--fullscreen');\r\n    }\r\n  };\r\n\r\n  newWindow.addEventListener(events[deviceType].down, (e) => {\r\n    if (e.target.closest('.window__draggable-area')) {\r\n      onWindowDrag(e);\r\n    }\r\n    if (e.target.closest('.window__content')) {\r\n      setCurrentWindowActive();\r\n    }\r\n  });\r\n\r\n  newWindow.addEventListener(events[deviceType].click, (e) => {\r\n    if (e.target.closest('.window__button--collapse')) {\r\n      onCollapseButton();\r\n    }\r\n    if (e.target.closest('.window__button--close')) {\r\n      onCloseButton();\r\n    }\r\n    if (e.target.closest('.window__button--expand')) {\r\n      onExpandButton();\r\n    }\r\n  });\r\n}\r\n"],"file":"window.js"}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtb2R1bGVzL3dpbmRvdy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4vdGhyb3R0bGUuanMnO1xyXG5pbXBvcnQgeyBldmVudHMsIGlzVG91Y2hEZXZpY2UsIGRldmljZVR5cGUgfSBmcm9tICcuL2NoZWNrRGV2aWNlVHlwZS5qcyc7XHJcblxyXG5pc1RvdWNoRGV2aWNlKCk7XHJcblxyXG5jb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZW1wbGF0ZScpO1xyXG5jb25zdCBkZXNrdG9wID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRlc2t0b3AnKTtcclxuY29uc3QgZGVza3RvcEZvb3RlciA9IGRlc2t0b3AucXVlcnlTZWxlY3RvcignLmRlc2t0b3BfX2Zvb3RlcicpO1xyXG5jb25zdCB3aW5kb3dUZW1wbGF0ZSA9IHRlbXBsYXRlLnF1ZXJ5U2VsZWN0b3IoJy53aW5kb3cnKTtcclxuY29uc3QgcmVmZXJlbmNlVGVtcGxhdGUgPSB0ZW1wbGF0ZS5xdWVyeVNlbGVjdG9yKCcucmVmZXJlbmNlJyk7XHJcbmxldCBpbml0aWFsekluZGV4ID0gMDtcclxubGV0IGluaXRpYWxYID0gMDtcclxubGV0IGluaXRpYWxZID0gMDtcclxubGV0IGxhc3RGaWxlO1xyXG5sZXQgbW92ZUVsZW1lbnQgPSBmYWxzZTtcclxubGV0IGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWwgPSAwO1xyXG5sZXQgaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpc29udGFsID0gMDtcclxubGV0IG9mZnNldFZlcnRpY2FsQ291bnRlciA9IDA7XHJcbmxldCBvZmZzZXRIb3Jpc29udGFsQ291bnRlciA9IDA7XHJcbmNvbnN0IGRlc2t0b3BXaWR0aCA9IGRlc2t0b3Aub2Zmc2V0V2lkdGg7XHJcbmNvbnN0IGRlc2t0b3BIZWlnaHQgPSBkZXNrdG9wLm9mZnNldEhlaWdodDtcclxuY29uc3QgaGFsZkRlc2t0b3BXaWR0aCA9IGRlc2t0b3BXaWR0aCAvIDI7XHJcbmNvbnN0IGhhbGZEZXNrdG9wSGVpZ2h0ID0gZGVza3RvcEhlaWdodCAvIDI7XHJcbmNvbnN0IHdpbmRvd1dpZHRoID0gTWF0aC5yb3VuZCh3aW5kb3cuaW5uZXJXaWR0aCAqIDAuNyk7XHJcbmNvbnN0IHdpbmRvd0hlaWdodCA9IE1hdGgucm91bmQod2luZG93LmlubmVySGVpZ2h0ICogMC43KTtcclxuXHJcbmRlc2t0b3BGb290ZXIuYWRkRXZlbnRMaXN0ZW5lcignd2hlZWwnLCAoZXZ0KSA9PiB7XHJcbiAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgZGVza3RvcEZvb3Rlci5zY3JvbGxMZWZ0ICs9IGV2dC5kZWx0YVk7XHJcbn0pO1xyXG5cclxuZGVza3RvcC5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgKGV2dCkgPT4ge1xyXG4gIGlmIChldnQudGFyZ2V0LmNsb3Nlc3QoJy5maWxlJykpIHtcclxuICAgIG9uRmlsZU9wZW4oZXZ0KTtcclxuICB9XHJcbn0pO1xyXG5cclxuY29uc3Qgc2V0U3RhcnRQb3NpdGlvbiA9IChlbGVtKSA9PiB7XHJcbiAgZWxlbS5jbGFzc0xpc3QucmVtb3ZlKCd3aW5kb3ctLWNvbGxhcHNlZCcpO1xyXG4gIGVsZW0uc3R5bGUubGVmdCA9IGAke2hhbGZEZXNrdG9wV2lkdGggKyBpbml0aWFsV2luZG93Q291bnRlckhvcmlzb250YWx9cHhgO1xyXG4gIGVsZW0uc3R5bGUudG9wID0gYCR7aGFsZkRlc2t0b3BIZWlnaHQgKyBpbml0aWFsV2luZG93Q291bnRlclZlcnRpY2FsfXB4YDtcclxuICBlbGVtLnN0eWxlLndpZHRoID0gYCR7d2luZG93V2lkdGh9cHhgO1xyXG4gIGVsZW0uc3R5bGUuaGVpZ2h0ID0gYCR7d2luZG93SGVpZ2h0fXB4YDtcclxuICBpZiAoaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpc29udGFsICsgKGRlc2t0b3BXaWR0aCAtIHdpbmRvd1dpZHRoKSAvIDIgKyAxMCArIHdpbmRvd1dpZHRoID49IGRlc2t0b3BXaWR0aCkge1xyXG4gICAgaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpc29udGFsID0gMDtcclxuICAgIG9mZnNldEhvcmlzb250YWxDb3VudGVyID0gMDtcclxuICB9IGVsc2Uge1xyXG4gICAgaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpc29udGFsICs9IDEwO1xyXG4gICAgb2Zmc2V0SG9yaXNvbnRhbENvdW50ZXIgKz0gMTtcclxuICB9XHJcbiAgaWYgKGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWwgKyAoZGVza3RvcEhlaWdodCAtIHdpbmRvd0hlaWdodCkgLyAyICsgMzAgKyB3aW5kb3dIZWlnaHQgPj0gZGVza3RvcEhlaWdodCkge1xyXG4gICAgaW5pdGlhbFdpbmRvd0NvdW50ZXJWZXJ0aWNhbCA9IDA7XHJcbiAgICBvZmZzZXRWZXJ0aWNhbENvdW50ZXIgPSAwO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBpbml0aWFsV2luZG93Q291bnRlclZlcnRpY2FsICs9IDMwO1xyXG4gICAgb2Zmc2V0VmVydGljYWxDb3VudGVyICs9IDE7XHJcbiAgfVxyXG59O1xyXG5cclxuZnVuY3Rpb24gb25GaWxlT3BlbihldnQpIHtcclxuICBldnQudGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGUnKTtcclxuICBldnQudGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ2ZpbGUtLW9wZW5lZCcpO1xyXG4gIGNvbnN0IGZpbGVMYWJlbCA9IGV2dC50YXJnZXQucXVlcnlTZWxlY3RvcignLmZpbGVfX2xhYmVsJyk7XHJcbiAgY29uc3QgZmlsZU5hbWUgPSBldnQudGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJy5maWxlX19uYW1lJyk7XHJcbiAgY29uc3QgcGF0aEljb24gPSBldnQudGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJy5maWxlX19pY29uJykuY2xvbmVOb2RlKHRydWUpO1xyXG4gIGNvbnN0IG5ld1dpbmRvdyA9IHdpbmRvd1RlbXBsYXRlLmNsb25lTm9kZSh0cnVlKTtcclxuICBjb25zdCBuZXdXaW5kb3dQYXRoID0gbmV3V2luZG93LnF1ZXJ5U2VsZWN0b3IoJy53aW5kb3dfX3BhdGgnKTtcclxuICBjb25zdCB3aW5kb3dIZWFkZXIgPSBuZXdXaW5kb3cucXVlcnlTZWxlY3RvcignLndpbmRvd19faGVhZGVyJyk7XHJcbiAgY29uc3Qgd2luZG93RHJhZ2dhYmxlQXJlYSA9IHdpbmRvd0hlYWRlci5xdWVyeVNlbGVjdG9yKCcud2luZG93X19kcmFnZ2FibGUtYXJlYScpO1xyXG4gIGNvbnN0IHJlZmVyZW5jZSA9IHJlZmVyZW5jZVRlbXBsYXRlLmNsb25lTm9kZSh0cnVlKTtcclxuXHJcbiAgY29uc3QgY2xvbmVkVGFyZ2V0Q29udGVudCA9IGV2dC50YXJnZXQucXVlcnlTZWxlY3RvcignLmZpbGVfX2NvbnRlbnQnKS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgbmV3V2luZG93LmFwcGVuZENoaWxkKGNsb25lZFRhcmdldENvbnRlbnQpO1xyXG4gIGNsb25lZFRhcmdldENvbnRlbnQuY2xhc3NMaXN0LnJlbW92ZSgndmlzdWFsbHktaGlkZGVuJyk7XHJcbiAgY2xvbmVkVGFyZ2V0Q29udGVudC5jbGFzc0xpc3QuYWRkKCd3aW5kb3dfX2NvbnRlbnQnKTtcclxuICBjbG9uZWRUYXJnZXRDb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGVfX2NvbnRlbnQnKTtcclxuICBpZiAoZXZ0LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ2ZpbGUtLWZvbGRlcicpKSB7XHJcbiAgICBjbG9uZWRUYXJnZXRDb250ZW50LmNsYXNzTGlzdC5hZGQoJ3dpbmRvd19fY29udGVudC0tZm9sZGVyJyk7XHJcbiAgfVxyXG5cclxuICBuZXdXaW5kb3dQYXRoLnRleHRDb250ZW50ID0gZmlsZU5hbWUudGV4dENvbnRlbnQ7XHJcbiAgd2luZG93RHJhZ2dhYmxlQXJlYS5pbnNlcnRCZWZvcmUocGF0aEljb24sIG5ld1dpbmRvd1BhdGgpO1xyXG4gIGRlc2t0b3AuYXBwZW5kQ2hpbGQobmV3V2luZG93KTtcclxuICBzZXRTdGFydFBvc2l0aW9uKG5ld1dpbmRvdyk7XHJcbiAgZmlsZUxhYmVsLmNsYXNzTGlzdC5hZGQoJ2ZpbGVfX2xhYmVsLS1hY3RpdmUnKTtcclxuXHJcbiAgY29uc3Qgc2V0Q3VycmVudFdpbmRvd0FjdGl2ZSA9ICgpID0+IHtcclxuICAgIGxhc3RGaWxlID0gcmVmZXJlbmNlO1xyXG4gICAgY29uc3QgbmV3ekluZGV4ID0gaW5pdGlhbHpJbmRleCArIDE7XHJcbiAgICBuZXdXaW5kb3cuc3R5bGUuekluZGV4ID0gYCR7bmV3ekluZGV4fWA7XHJcbiAgICBpbml0aWFsekluZGV4ID0gbmV3ekluZGV4O1xyXG4gICAgcmVmZXJlbmNlLmNsYXNzTGlzdC5hZGQoJ3JlZmVyZW5jZS0tYWN0aXZlJyk7XHJcbiAgICBkZXNrdG9wLnF1ZXJ5U2VsZWN0b3JBbGwoJy53aW5kb3ctLWFjdGl2ZScpLmZvckVhY2goKGEpID0+IHtcclxuICAgICAgYS5jbGFzc0xpc3QucmVtb3ZlKCd3aW5kb3ctLWFjdGl2ZScpO1xyXG4gICAgfSk7XHJcbiAgICBuZXdXaW5kb3cuY2xhc3NMaXN0LmFkZCgnd2luZG93LS1hY3RpdmUnKTtcclxuICAgIGRlc2t0b3AucXVlcnlTZWxlY3RvckFsbCgnLnJlZmVyZW5jZScpLmZvckVhY2goKGIpID0+IHtcclxuICAgICAgaWYgKGIgPT09IGxhc3RGaWxlKSB7XHJcbiAgICAgICAgYi5jbGFzc0xpc3QuYWRkKCdyZWZlcmVuY2UtLWFjdGl2ZScpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGIuY2xhc3NMaXN0LnJlbW92ZSgncmVmZXJlbmNlLS1hY3RpdmUnKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcbiAgc2V0Q3VycmVudFdpbmRvd0FjdGl2ZSgpO1xyXG5cclxuICBjb25zdCBvbk1vdmVFdmVudCA9IChlKSA9PiB7XHJcbiAgICBpZiAobW92ZUVsZW1lbnQgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgbmV3WCA9ICFpc1RvdWNoRGV2aWNlKCkgPyBlLmNsaWVudFggOiBlLnRvdWNoZXNbMF0uY2xpZW50WDtcclxuICAgICAgY29uc3QgbmV3WSA9ICFpc1RvdWNoRGV2aWNlKCkgPyBlLmNsaWVudFkgOiBlLnRvdWNoZXNbMF0uY2xpZW50WTtcclxuICAgICAgY29uc3QgY2FsY1ggPSBpbml0aWFsWCAtIG5ld1g7XHJcbiAgICAgIGNvbnN0IGNhbGNZID0gaW5pdGlhbFkgLSBuZXdZO1xyXG4gICAgICBjb25zdCBsZWZ0UG9zaXRpb24gPSBgJHtuZXdXaW5kb3cub2Zmc2V0TGVmdCAtIGNhbGNYfXB4YDtcclxuICAgICAgY29uc3QgdG9wUG9zaXRpb24gPSBgJHtuZXdXaW5kb3cub2Zmc2V0VG9wIC0gY2FsY1l9cHhgO1xyXG4gICAgICBuZXdXaW5kb3cuc3R5bGUubGVmdCA9IGxlZnRQb3NpdGlvbjtcclxuICAgICAgbmV3V2luZG93LnN0eWxlLnRvcCA9IHRvcFBvc2l0aW9uO1xyXG4gICAgICBpbml0aWFsWCA9IG5ld1g7XHJcbiAgICAgIGluaXRpYWxZID0gbmV3WTtcclxuICAgIH1cclxuICB9O1xyXG4gIGNvbnN0IG9uTW92ZVRocm90dGxlZCA9IHRocm90dGxlKG9uTW92ZUV2ZW50LCAxMCk7XHJcblxyXG4gIGNvbnN0IG9uTW92ZVN0b3AgPSAoKSA9PiB7XHJcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5tb3ZlLCBvbk1vdmVUaHJvdHRsZWQpO1xyXG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0udXAsIG9uTW92ZVN0b3ApO1xyXG4gICAgbW92ZUVsZW1lbnQgPSBmYWxzZTtcclxuICB9O1xyXG5cclxuICBmdW5jdGlvbiBvbldpbmRvd0RyYWcoZSkge1xyXG4gICAgc2V0Q3VycmVudFdpbmRvd0FjdGl2ZSgpO1xyXG4gICAgaWYgKGUuY2FuY2VsYWJsZSkge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB9XHJcbiAgICBpZiAoIW5ld1dpbmRvdy5jbGFzc0xpc3QuY29udGFpbnMoJ3dpbmRvdy0tZnVsbHNjcmVlbicpKSB7XHJcbiAgICAgIG1vdmVFbGVtZW50ID0gdHJ1ZTtcclxuICAgICAgaW5pdGlhbFggPSAhaXNUb3VjaERldmljZSgpID8gZS5jbGllbnRYIDogZS50b3VjaGVzWzBdLmNsaWVudFg7XHJcbiAgICAgIGluaXRpYWxZID0gIWlzVG91Y2hEZXZpY2UoKSA/IGUuY2xpZW50WSA6IGUudG91Y2hlc1swXS5jbGllbnRZO1xyXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5tb3ZlLCBvbk1vdmVUaHJvdHRsZWQpO1xyXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS51cCwgb25Nb3ZlU3RvcCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBvbkNvbGxhcHNlQnV0dG9uID0gKCkgPT4ge1xyXG4gICAgaWYgKG5ld1dpbmRvdy5jbGFzc0xpc3QuY29udGFpbnMoJ3dpbmRvdy0tY29sbGFwc2VkJykpIHtcclxuICAgICAgbmV3V2luZG93LmNsYXNzTGlzdC5yZW1vdmUoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgICAgIHNldEN1cnJlbnRXaW5kb3dBY3RpdmUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChyZWZlcmVuY2UgPT09IGxhc3RGaWxlKSB7XHJcbiAgICAgICAgbmV3V2luZG93LmNsYXNzTGlzdC5hZGQoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2V0Q3VycmVudFdpbmRvd0FjdGl2ZSgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgcmVmZXJlbmNlSWNvbiA9IGV2dC50YXJnZXQucXVlcnlTZWxlY3RvcignLmZpbGVfX2ljb24nKS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgY29uc3QgcmVmZXJlbmNlVGV4dCA9IHJlZmVyZW5jZS5xdWVyeVNlbGVjdG9yKCcucmVmZXJlbmNlX190ZXh0Jyk7XHJcbiAgcmVmZXJlbmNlVGV4dC50ZXh0Q29udGVudCA9IGZpbGVOYW1lLnRleHRDb250ZW50O1xyXG4gIHJlZmVyZW5jZS5pbnNlcnRCZWZvcmUocmVmZXJlbmNlSWNvbiwgcmVmZXJlbmNlVGV4dCk7XHJcbiAgZGVza3RvcEZvb3Rlci5hcHBlbmRDaGlsZChyZWZlcmVuY2UpO1xyXG4gIHJlZmVyZW5jZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgb25Db2xsYXBzZUJ1dHRvbik7XHJcblxyXG4gIGNvbnN0IG9uQ2xvc2VCdXR0b24gPSAoKSA9PiB7XHJcbiAgICBldnQudGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ2ZpbGUnKTtcclxuICAgIGV2dC50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgnZmlsZS0tb3BlbmVkJyk7XHJcbiAgICBzZXRDdXJyZW50V2luZG93QWN0aXZlKCk7XHJcbiAgICBuZXdXaW5kb3cucmVtb3ZlKCk7XHJcbiAgICBwYXRoSWNvbi5yZW1vdmUoKTtcclxuICAgIHJlZmVyZW5jZS5yZW1vdmUoKTtcclxuICAgIGNsb25lZFRhcmdldENvbnRlbnQucmVtb3ZlKCk7XHJcbiAgICByZWZlcmVuY2VJY29uLnJlbW92ZSgpO1xyXG4gICAgZmlsZUxhYmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGVfX2xhYmVsLS1hY3RpdmUnKTtcclxuICAgIGlmIChvZmZzZXRWZXJ0aWNhbENvdW50ZXIgPiAwKSB7XHJcbiAgICAgIG9mZnNldFZlcnRpY2FsQ291bnRlciAtPSAxO1xyXG4gICAgICBpbml0aWFsV2luZG93Q291bnRlclZlcnRpY2FsIC09IDMwO1xyXG4gICAgfVxyXG4gICAgaWYgKG9mZnNldEhvcmlzb250YWxDb3VudGVyID4gMCkge1xyXG4gICAgICBvZmZzZXRIb3Jpc29udGFsQ291bnRlciAtPSAxO1xyXG4gICAgICBpbml0aWFsV2luZG93Q291bnRlckhvcmlzb250YWwgLT0gMTA7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY29uc3Qgb25FeHBhbmRCdXR0b24gPSAoKSA9PiB7XHJcbiAgICBzZXRDdXJyZW50V2luZG93QWN0aXZlKHJlZmVyZW5jZSwgbmV3V2luZG93KTtcclxuICAgIGlmIChuZXdXaW5kb3cuY2xhc3NMaXN0LmNvbnRhaW5zKCd3aW5kb3ctLWZ1bGxzY3JlZW4nKSkge1xyXG4gICAgICBuZXdXaW5kb3cuY2xhc3NMaXN0LnJlbW92ZSgnd2luZG93LS1mdWxsc2NyZWVuJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBuZXdXaW5kb3cuY2xhc3NMaXN0LmFkZCgnd2luZG93LS1mdWxsc2NyZWVuJyk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgbmV3V2luZG93LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLmRvd24sIChlKSA9PiB7XHJcbiAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnLndpbmRvd19fZHJhZ2dhYmxlLWFyZWEnKSkge1xyXG4gICAgICBvbldpbmRvd0RyYWcoZSk7XHJcbiAgICB9XHJcbiAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnLndpbmRvd19fY29udGVudCcpKSB7XHJcbiAgICAgIHNldEN1cnJlbnRXaW5kb3dBY3RpdmUoKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgbmV3V2luZG93LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLmNsaWNrLCAoZSkgPT4ge1xyXG4gICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy53aW5kb3dfX2J1dHRvbi0tY29sbGFwc2UnKSkge1xyXG4gICAgICBvbkNvbGxhcHNlQnV0dG9uKCk7XHJcbiAgICB9XHJcbiAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnLndpbmRvd19fYnV0dG9uLS1jbG9zZScpKSB7XHJcbiAgICAgIG9uQ2xvc2VCdXR0b24oKTtcclxuICAgIH1cclxuICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcud2luZG93X19idXR0b24tLWV4cGFuZCcpKSB7XHJcbiAgICAgIG9uRXhwYW5kQnV0dG9uKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuIl0sImZpbGUiOiJ3aW5kb3cuanMifQ==