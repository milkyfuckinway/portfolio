{"version":3,"names":[],"mappings":"","sources":["modules/window.js"],"sourcesContent":["import { throttle } from './throttle.js';\r\nimport { isTouchDevice, deviceType } from './checkDeviceType.js';\r\n\r\nisTouchDevice();\r\n\r\nconst events = {\r\n  mouse: {\r\n    down: 'mousedown',\r\n    move: 'mousemove',\r\n    up: 'mouseup',\r\n    click: 'click',\r\n  },\r\n  touch: {\r\n    down: 'touchstart',\r\n    move: 'touchmove',\r\n    up: 'touchend',\r\n    click: 'click',\r\n  },\r\n};\r\n\r\nconst template = document.querySelector('.template');\r\nconst desktop = document.querySelector('.desktop');\r\nconst desktopFooter = desktop.querySelector('.desktop__footer');\r\nconst windowTemplate = template.querySelector('.window');\r\nconst referenceTemplate = template.querySelector('.reference');\r\nconst desktopWidth = desktop.offsetWidth;\r\nconst desktopHeight = desktop.offsetHeight;\r\nconst halfDesktopWidth = desktopWidth / 2;\r\nconst halfDesktopHeight = desktopHeight / 2;\r\n\r\nconst coefficientWidth = () => {\r\n  if (desktopWidth < 500) {\r\n    return 0.9;\r\n  } else {\r\n    return 0.5;\r\n  }\r\n};\r\n\r\nconst coefficientHeight = () => {\r\n  if (desktopWidth < 500) {\r\n    return 0.7;\r\n  } else {\r\n    return 0.5;\r\n  }\r\n};\r\n\r\nconst windowWidth = Math.round(window.innerWidth * coefficientWidth());\r\nconst windowHeight = Math.round(window.innerHeight * coefficientHeight());\r\n\r\nconst fileList = document.querySelectorAll('.file');\r\nfileList[1].children[0].classList.add('file__label--active');\r\n\r\nlet initialIndex = 0;\r\nlet initialX = 0;\r\nlet initialY = 0;\r\nlet lastReference;\r\nlet moveElement = false;\r\nlet initialWindowCounterVertical = 0;\r\nlet initialWindowCounterHorizontal = 0;\r\nlet offsetVerticalCounter = 0;\r\nlet offsetHorizontalCounter = 0;\r\n\r\nconst setStartPosition = (elem) => {\r\n  elem.classList.remove('window--collapsed');\r\n  elem.style.left = `${halfDesktopWidth + initialWindowCounterHorizontal}px`;\r\n  elem.style.top = `${halfDesktopHeight + initialWindowCounterVertical}px`;\r\n  elem.style.width = `${windowWidth}px`;\r\n  elem.style.height = `${windowHeight}px`;\r\n  if (initialWindowCounterHorizontal + (desktopWidth - windowWidth) / 2 + 10 + windowWidth >= desktopWidth) {\r\n    initialWindowCounterHorizontal = 0;\r\n    offsetHorizontalCounter = 0;\r\n  } else {\r\n    initialWindowCounterHorizontal += 8;\r\n    offsetHorizontalCounter += 1;\r\n  }\r\n  if (initialWindowCounterVertical + (desktopHeight - windowHeight) / 2 + 30 + windowHeight >= desktopHeight) {\r\n    initialWindowCounterVertical = 0;\r\n    offsetVerticalCounter = 0;\r\n  } else {\r\n    initialWindowCounterVertical += 40;\r\n    offsetVerticalCounter += 1;\r\n  }\r\n};\r\n\r\nconst onFileOpen = (evt) => {\r\n  evt.preventDefault();\r\n  evt.target.classList.remove('file');\r\n  evt.target.classList.add('file--opened');\r\n  const fileLabel = evt.target.querySelector('.file__label');\r\n  const fileName = evt.target.querySelector('.file__name');\r\n  const fileIcon = evt.target.querySelector('.file__icon').cloneNode(true);\r\n  fileIcon.classList.remove('file__icon--desktop');\r\n  const newWindow = windowTemplate.cloneNode(true);\r\n  const newWindowPath = newWindow.querySelector('.window__path');\r\n  const windowHeader = newWindow.querySelector('.window__header');\r\n  const windowDraggableArea = windowHeader.querySelector('.window__draggable-area');\r\n  const reference = referenceTemplate.cloneNode(true);\r\n  newWindowPath.textContent = fileName.textContent;\r\n  windowDraggableArea.insertBefore(fileIcon, newWindowPath);\r\n  desktop.appendChild(newWindow);\r\n  setStartPosition(newWindow);\r\n  fileLabel.classList.add('file__label--active');\r\n  const clonedTargetContent = evt.target.querySelector('.file__content').cloneNode(true);\r\n  newWindow.appendChild(clonedTargetContent);\r\n  clonedTargetContent.classList.remove('visually-hidden');\r\n  clonedTargetContent.classList.add('window__content');\r\n  clonedTargetContent.classList.remove('file__content');\r\n  if (evt.target.classList.contains('file--folder')) {\r\n    clonedTargetContent.classList.add('grid--folder');\r\n  }\r\n\r\n  const setCurrentWindowActive = () => {\r\n    lastReference = reference;\r\n    const newIndex = initialIndex + 1;\r\n    newWindow.style.zIndex = `${newIndex}`;\r\n    initialIndex = newIndex;\r\n    reference.classList.add('reference--active');\r\n    desktop.querySelectorAll('.window--active').forEach((a) => {\r\n      a.classList.remove('window--active');\r\n    });\r\n    newWindow.classList.add('window--active');\r\n    desktop.querySelectorAll('.reference').forEach((b) => {\r\n      if (b === lastReference) {\r\n        b.classList.add('reference--active');\r\n      } else {\r\n        b.classList.remove('reference--active');\r\n      }\r\n    });\r\n  };\r\n\r\n  setCurrentWindowActive();\r\n\r\n  const onMoveEvent = (e) => {\r\n    if (moveElement) {\r\n      e.stopPropagation();\r\n      const newX = !isTouchDevice() ? e.clientX : e.touches[0].clientX;\r\n      const newY = !isTouchDevice() ? e.clientY : e.touches[0].clientY;\r\n      const calcX = initialX - newX;\r\n      const calcY = initialY - newY;\r\n      const leftPosition = `${newWindow.offsetLeft - calcX}px`;\r\n      const topPosition = `${newWindow.offsetTop - calcY}px`;\r\n      newWindow.style.left = leftPosition;\r\n      newWindow.style.top = topPosition;\r\n      initialX = newX;\r\n      initialY = newY;\r\n    }\r\n  };\r\n\r\n  const onMoveThrottled = throttle(onMoveEvent, 10);\r\n\r\n  const onMoveStop = () => {\r\n    document.removeEventListener(events[deviceType].move, onMoveThrottled);\r\n    document.removeEventListener(events[deviceType].up, onMoveStop);\r\n    moveElement = false;\r\n  };\r\n\r\n  const onWindowDrag = (e) => {\r\n    setCurrentWindowActive();\r\n    e.stopPropagation();\r\n    if (e.cancelable) {\r\n      e.preventDefault();\r\n    }\r\n    if (!newWindow.classList.contains('window--fullscreen')) {\r\n      moveElement = true;\r\n      initialX = !isTouchDevice() ? e.clientX : e.touches[0].clientX;\r\n      initialY = !isTouchDevice() ? e.clientY : e.touches[0].clientY;\r\n      document.addEventListener(events[deviceType].move, onMoveThrottled);\r\n      document.addEventListener(events[deviceType].up, onMoveStop);\r\n    }\r\n  };\r\n\r\n  const onCollapseButton = () => {\r\n    if (newWindow.classList.contains('window--collapsed')) {\r\n      newWindow.classList.remove('window--collapsed');\r\n      setCurrentWindowActive();\r\n    } else {\r\n      if (reference === lastReference) {\r\n        newWindow.classList.add('window--collapsed');\r\n      } else {\r\n        setCurrentWindowActive();\r\n      }\r\n    }\r\n  };\r\n\r\n  const onExpandButton = () => {\r\n    setCurrentWindowActive(reference, newWindow);\r\n    if (newWindow.classList.contains('window--fullscreen')) {\r\n      newWindow.classList.remove('window--fullscreen');\r\n    } else {\r\n      newWindow.classList.add('window--fullscreen');\r\n    }\r\n  };\r\n\r\n  const onCloseButton = () => {\r\n    evt.target.classList.add('file');\r\n    evt.target.classList.remove('file--opened');\r\n    setCurrentWindowActive();\r\n    newWindow.remove();\r\n    reference.remove();\r\n    fileLabel.classList.remove('file__label--active');\r\n    if (offsetVerticalCounter > 0) {\r\n      offsetVerticalCounter -= 1;\r\n      initialWindowCounterVertical -= 30;\r\n    }\r\n    if (offsetHorizontalCounter > 0) {\r\n      offsetHorizontalCounter -= 1;\r\n      initialWindowCounterHorizontal -= 10;\r\n    }\r\n  };\r\n\r\n  const referenceIcon = evt.target.querySelector('.file__icon').cloneNode(true);\r\n  referenceIcon.classList.remove('file__icon--desktop');\r\n  const referenceText = reference.querySelector('.reference__text');\r\n  referenceText.textContent = fileName.textContent;\r\n  reference.insertBefore(referenceIcon, referenceText);\r\n  desktopFooter.appendChild(reference);\r\n  reference.addEventListener(events[deviceType].click, onCollapseButton);\r\n\r\n  newWindow.addEventListener(events[deviceType].down, (e) => {\r\n    if (e.target.closest('.window__draggable-area')) {\r\n      onWindowDrag(e);\r\n    }\r\n    if (e.target.closest('.window__content')) {\r\n      setCurrentWindowActive();\r\n    }\r\n  });\r\n\r\n  newWindow.addEventListener(events[deviceType].click, (e) => {\r\n    if (e.target.closest('.window__button--collapse')) {\r\n      onCollapseButton();\r\n    }\r\n    if (e.target.closest('.window__button--close')) {\r\n      onCloseButton();\r\n    }\r\n    if (e.target.closest('.window__button--expand')) {\r\n      onExpandButton();\r\n    }\r\n  });\r\n};\r\n\r\ndesktopFooter.addEventListener('wheel', (evt) => {\r\n  evt.preventDefault();\r\n  desktopFooter.scrollLeft += evt.deltaY;\r\n});\r\n\r\ndesktop.addEventListener(events[deviceType].click, (evt) => {\r\n  if (evt.target.closest('.file') && !evt.target.closest('.file--link')) {\r\n    onFileOpen(evt);\r\n  }\r\n});\r\n"],"file":"window.js"}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtb2R1bGVzL3dpbmRvdy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4vdGhyb3R0bGUuanMnO1xyXG5pbXBvcnQgeyBpc1RvdWNoRGV2aWNlLCBkZXZpY2VUeXBlIH0gZnJvbSAnLi9jaGVja0RldmljZVR5cGUuanMnO1xyXG5cclxuaXNUb3VjaERldmljZSgpO1xyXG5cclxuY29uc3QgZXZlbnRzID0ge1xyXG4gIG1vdXNlOiB7XHJcbiAgICBkb3duOiAnbW91c2Vkb3duJyxcclxuICAgIG1vdmU6ICdtb3VzZW1vdmUnLFxyXG4gICAgdXA6ICdtb3VzZXVwJyxcclxuICAgIGNsaWNrOiAnY2xpY2snLFxyXG4gIH0sXHJcbiAgdG91Y2g6IHtcclxuICAgIGRvd246ICd0b3VjaHN0YXJ0JyxcclxuICAgIG1vdmU6ICd0b3VjaG1vdmUnLFxyXG4gICAgdXA6ICd0b3VjaGVuZCcsXHJcbiAgICBjbGljazogJ2NsaWNrJyxcclxuICB9LFxyXG59O1xyXG5cclxuY29uc3QgdGVtcGxhdGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVtcGxhdGUnKTtcclxuY29uc3QgZGVza3RvcCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kZXNrdG9wJyk7XHJcbmNvbnN0IGRlc2t0b3BGb290ZXIgPSBkZXNrdG9wLnF1ZXJ5U2VsZWN0b3IoJy5kZXNrdG9wX19mb290ZXInKTtcclxuY29uc3Qgd2luZG93VGVtcGxhdGUgPSB0ZW1wbGF0ZS5xdWVyeVNlbGVjdG9yKCcud2luZG93Jyk7XHJcbmNvbnN0IHJlZmVyZW5jZVRlbXBsYXRlID0gdGVtcGxhdGUucXVlcnlTZWxlY3RvcignLnJlZmVyZW5jZScpO1xyXG5jb25zdCBkZXNrdG9wV2lkdGggPSBkZXNrdG9wLm9mZnNldFdpZHRoO1xyXG5jb25zdCBkZXNrdG9wSGVpZ2h0ID0gZGVza3RvcC5vZmZzZXRIZWlnaHQ7XHJcbmNvbnN0IGhhbGZEZXNrdG9wV2lkdGggPSBkZXNrdG9wV2lkdGggLyAyO1xyXG5jb25zdCBoYWxmRGVza3RvcEhlaWdodCA9IGRlc2t0b3BIZWlnaHQgLyAyO1xyXG5cclxuY29uc3QgY29lZmZpY2llbnRXaWR0aCA9ICgpID0+IHtcclxuICBpZiAoZGVza3RvcFdpZHRoIDwgNTAwKSB7XHJcbiAgICByZXR1cm4gMC45O1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gMC41O1xyXG4gIH1cclxufTtcclxuXHJcbmNvbnN0IGNvZWZmaWNpZW50SGVpZ2h0ID0gKCkgPT4ge1xyXG4gIGlmIChkZXNrdG9wV2lkdGggPCA1MDApIHtcclxuICAgIHJldHVybiAwLjc7XHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiAwLjU7XHJcbiAgfVxyXG59O1xyXG5cclxuY29uc3Qgd2luZG93V2lkdGggPSBNYXRoLnJvdW5kKHdpbmRvdy5pbm5lcldpZHRoICogY29lZmZpY2llbnRXaWR0aCgpKTtcclxuY29uc3Qgd2luZG93SGVpZ2h0ID0gTWF0aC5yb3VuZCh3aW5kb3cuaW5uZXJIZWlnaHQgKiBjb2VmZmljaWVudEhlaWdodCgpKTtcclxuXHJcbmNvbnN0IGZpbGVMaXN0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmZpbGUnKTtcclxuZmlsZUxpc3RbMV0uY2hpbGRyZW5bMF0uY2xhc3NMaXN0LmFkZCgnZmlsZV9fbGFiZWwtLWFjdGl2ZScpO1xyXG5cclxubGV0IGluaXRpYWxJbmRleCA9IDA7XHJcbmxldCBpbml0aWFsWCA9IDA7XHJcbmxldCBpbml0aWFsWSA9IDA7XHJcbmxldCBsYXN0UmVmZXJlbmNlO1xyXG5sZXQgbW92ZUVsZW1lbnQgPSBmYWxzZTtcclxubGV0IGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWwgPSAwO1xyXG5sZXQgaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpem9udGFsID0gMDtcclxubGV0IG9mZnNldFZlcnRpY2FsQ291bnRlciA9IDA7XHJcbmxldCBvZmZzZXRIb3Jpem9udGFsQ291bnRlciA9IDA7XHJcblxyXG5jb25zdCBzZXRTdGFydFBvc2l0aW9uID0gKGVsZW0pID0+IHtcclxuICBlbGVtLmNsYXNzTGlzdC5yZW1vdmUoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgZWxlbS5zdHlsZS5sZWZ0ID0gYCR7aGFsZkRlc2t0b3BXaWR0aCArIGluaXRpYWxXaW5kb3dDb3VudGVySG9yaXpvbnRhbH1weGA7XHJcbiAgZWxlbS5zdHlsZS50b3AgPSBgJHtoYWxmRGVza3RvcEhlaWdodCArIGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWx9cHhgO1xyXG4gIGVsZW0uc3R5bGUud2lkdGggPSBgJHt3aW5kb3dXaWR0aH1weGA7XHJcbiAgZWxlbS5zdHlsZS5oZWlnaHQgPSBgJHt3aW5kb3dIZWlnaHR9cHhgO1xyXG4gIGlmIChpbml0aWFsV2luZG93Q291bnRlckhvcml6b250YWwgKyAoZGVza3RvcFdpZHRoIC0gd2luZG93V2lkdGgpIC8gMiArIDEwICsgd2luZG93V2lkdGggPj0gZGVza3RvcFdpZHRoKSB7XHJcbiAgICBpbml0aWFsV2luZG93Q291bnRlckhvcml6b250YWwgPSAwO1xyXG4gICAgb2Zmc2V0SG9yaXpvbnRhbENvdW50ZXIgPSAwO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBpbml0aWFsV2luZG93Q291bnRlckhvcml6b250YWwgKz0gODtcclxuICAgIG9mZnNldEhvcml6b250YWxDb3VudGVyICs9IDE7XHJcbiAgfVxyXG4gIGlmIChpbml0aWFsV2luZG93Q291bnRlclZlcnRpY2FsICsgKGRlc2t0b3BIZWlnaHQgLSB3aW5kb3dIZWlnaHQpIC8gMiArIDMwICsgd2luZG93SGVpZ2h0ID49IGRlc2t0b3BIZWlnaHQpIHtcclxuICAgIGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWwgPSAwO1xyXG4gICAgb2Zmc2V0VmVydGljYWxDb3VudGVyID0gMDtcclxuICB9IGVsc2Uge1xyXG4gICAgaW5pdGlhbFdpbmRvd0NvdW50ZXJWZXJ0aWNhbCArPSA0MDtcclxuICAgIG9mZnNldFZlcnRpY2FsQ291bnRlciArPSAxO1xyXG4gIH1cclxufTtcclxuXHJcbmNvbnN0IG9uRmlsZU9wZW4gPSAoZXZ0KSA9PiB7XHJcbiAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgZXZ0LnRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCdmaWxlJyk7XHJcbiAgZXZ0LnRhcmdldC5jbGFzc0xpc3QuYWRkKCdmaWxlLS1vcGVuZWQnKTtcclxuICBjb25zdCBmaWxlTGFiZWwgPSBldnQudGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJy5maWxlX19sYWJlbCcpO1xyXG4gIGNvbnN0IGZpbGVOYW1lID0gZXZ0LnRhcmdldC5xdWVyeVNlbGVjdG9yKCcuZmlsZV9fbmFtZScpO1xyXG4gIGNvbnN0IGZpbGVJY29uID0gZXZ0LnRhcmdldC5xdWVyeVNlbGVjdG9yKCcuZmlsZV9faWNvbicpLmNsb25lTm9kZSh0cnVlKTtcclxuICBmaWxlSWNvbi5jbGFzc0xpc3QucmVtb3ZlKCdmaWxlX19pY29uLS1kZXNrdG9wJyk7XHJcbiAgY29uc3QgbmV3V2luZG93ID0gd2luZG93VGVtcGxhdGUuY2xvbmVOb2RlKHRydWUpO1xyXG4gIGNvbnN0IG5ld1dpbmRvd1BhdGggPSBuZXdXaW5kb3cucXVlcnlTZWxlY3RvcignLndpbmRvd19fcGF0aCcpO1xyXG4gIGNvbnN0IHdpbmRvd0hlYWRlciA9IG5ld1dpbmRvdy5xdWVyeVNlbGVjdG9yKCcud2luZG93X19oZWFkZXInKTtcclxuICBjb25zdCB3aW5kb3dEcmFnZ2FibGVBcmVhID0gd2luZG93SGVhZGVyLnF1ZXJ5U2VsZWN0b3IoJy53aW5kb3dfX2RyYWdnYWJsZS1hcmVhJyk7XHJcbiAgY29uc3QgcmVmZXJlbmNlID0gcmVmZXJlbmNlVGVtcGxhdGUuY2xvbmVOb2RlKHRydWUpO1xyXG4gIG5ld1dpbmRvd1BhdGgudGV4dENvbnRlbnQgPSBmaWxlTmFtZS50ZXh0Q29udGVudDtcclxuICB3aW5kb3dEcmFnZ2FibGVBcmVhLmluc2VydEJlZm9yZShmaWxlSWNvbiwgbmV3V2luZG93UGF0aCk7XHJcbiAgZGVza3RvcC5hcHBlbmRDaGlsZChuZXdXaW5kb3cpO1xyXG4gIHNldFN0YXJ0UG9zaXRpb24obmV3V2luZG93KTtcclxuICBmaWxlTGFiZWwuY2xhc3NMaXN0LmFkZCgnZmlsZV9fbGFiZWwtLWFjdGl2ZScpO1xyXG4gIGNvbnN0IGNsb25lZFRhcmdldENvbnRlbnQgPSBldnQudGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJy5maWxlX19jb250ZW50JykuY2xvbmVOb2RlKHRydWUpO1xyXG4gIG5ld1dpbmRvdy5hcHBlbmRDaGlsZChjbG9uZWRUYXJnZXRDb250ZW50KTtcclxuICBjbG9uZWRUYXJnZXRDb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoJ3Zpc3VhbGx5LWhpZGRlbicpO1xyXG4gIGNsb25lZFRhcmdldENvbnRlbnQuY2xhc3NMaXN0LmFkZCgnd2luZG93X19jb250ZW50Jyk7XHJcbiAgY2xvbmVkVGFyZ2V0Q29udGVudC5jbGFzc0xpc3QucmVtb3ZlKCdmaWxlX19jb250ZW50Jyk7XHJcbiAgaWYgKGV2dC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdmaWxlLS1mb2xkZXInKSkge1xyXG4gICAgY2xvbmVkVGFyZ2V0Q29udGVudC5jbGFzc0xpc3QuYWRkKCdncmlkLS1mb2xkZXInKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHNldEN1cnJlbnRXaW5kb3dBY3RpdmUgPSAoKSA9PiB7XHJcbiAgICBsYXN0UmVmZXJlbmNlID0gcmVmZXJlbmNlO1xyXG4gICAgY29uc3QgbmV3SW5kZXggPSBpbml0aWFsSW5kZXggKyAxO1xyXG4gICAgbmV3V2luZG93LnN0eWxlLnpJbmRleCA9IGAke25ld0luZGV4fWA7XHJcbiAgICBpbml0aWFsSW5kZXggPSBuZXdJbmRleDtcclxuICAgIHJlZmVyZW5jZS5jbGFzc0xpc3QuYWRkKCdyZWZlcmVuY2UtLWFjdGl2ZScpO1xyXG4gICAgZGVza3RvcC5xdWVyeVNlbGVjdG9yQWxsKCcud2luZG93LS1hY3RpdmUnKS5mb3JFYWNoKChhKSA9PiB7XHJcbiAgICAgIGEuY2xhc3NMaXN0LnJlbW92ZSgnd2luZG93LS1hY3RpdmUnKTtcclxuICAgIH0pO1xyXG4gICAgbmV3V2luZG93LmNsYXNzTGlzdC5hZGQoJ3dpbmRvdy0tYWN0aXZlJyk7XHJcbiAgICBkZXNrdG9wLnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZWZlcmVuY2UnKS5mb3JFYWNoKChiKSA9PiB7XHJcbiAgICAgIGlmIChiID09PSBsYXN0UmVmZXJlbmNlKSB7XHJcbiAgICAgICAgYi5jbGFzc0xpc3QuYWRkKCdyZWZlcmVuY2UtLWFjdGl2ZScpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGIuY2xhc3NMaXN0LnJlbW92ZSgncmVmZXJlbmNlLS1hY3RpdmUnKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfTtcclxuXHJcbiAgc2V0Q3VycmVudFdpbmRvd0FjdGl2ZSgpO1xyXG5cclxuICBjb25zdCBvbk1vdmVFdmVudCA9IChlKSA9PiB7XHJcbiAgICBpZiAobW92ZUVsZW1lbnQpIHtcclxuICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgY29uc3QgbmV3WCA9ICFpc1RvdWNoRGV2aWNlKCkgPyBlLmNsaWVudFggOiBlLnRvdWNoZXNbMF0uY2xpZW50WDtcclxuICAgICAgY29uc3QgbmV3WSA9ICFpc1RvdWNoRGV2aWNlKCkgPyBlLmNsaWVudFkgOiBlLnRvdWNoZXNbMF0uY2xpZW50WTtcclxuICAgICAgY29uc3QgY2FsY1ggPSBpbml0aWFsWCAtIG5ld1g7XHJcbiAgICAgIGNvbnN0IGNhbGNZID0gaW5pdGlhbFkgLSBuZXdZO1xyXG4gICAgICBjb25zdCBsZWZ0UG9zaXRpb24gPSBgJHtuZXdXaW5kb3cub2Zmc2V0TGVmdCAtIGNhbGNYfXB4YDtcclxuICAgICAgY29uc3QgdG9wUG9zaXRpb24gPSBgJHtuZXdXaW5kb3cub2Zmc2V0VG9wIC0gY2FsY1l9cHhgO1xyXG4gICAgICBuZXdXaW5kb3cuc3R5bGUubGVmdCA9IGxlZnRQb3NpdGlvbjtcclxuICAgICAgbmV3V2luZG93LnN0eWxlLnRvcCA9IHRvcFBvc2l0aW9uO1xyXG4gICAgICBpbml0aWFsWCA9IG5ld1g7XHJcbiAgICAgIGluaXRpYWxZID0gbmV3WTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBvbk1vdmVUaHJvdHRsZWQgPSB0aHJvdHRsZShvbk1vdmVFdmVudCwgMTApO1xyXG5cclxuICBjb25zdCBvbk1vdmVTdG9wID0gKCkgPT4ge1xyXG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0ubW92ZSwgb25Nb3ZlVGhyb3R0bGVkKTtcclxuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLnVwLCBvbk1vdmVTdG9wKTtcclxuICAgIG1vdmVFbGVtZW50ID0gZmFsc2U7XHJcbiAgfTtcclxuXHJcbiAgY29uc3Qgb25XaW5kb3dEcmFnID0gKGUpID0+IHtcclxuICAgIHNldEN1cnJlbnRXaW5kb3dBY3RpdmUoKTtcclxuICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICBpZiAoZS5jYW5jZWxhYmxlKSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIH1cclxuICAgIGlmICghbmV3V2luZG93LmNsYXNzTGlzdC5jb250YWlucygnd2luZG93LS1mdWxsc2NyZWVuJykpIHtcclxuICAgICAgbW92ZUVsZW1lbnQgPSB0cnVlO1xyXG4gICAgICBpbml0aWFsWCA9ICFpc1RvdWNoRGV2aWNlKCkgPyBlLmNsaWVudFggOiBlLnRvdWNoZXNbMF0uY2xpZW50WDtcclxuICAgICAgaW5pdGlhbFkgPSAhaXNUb3VjaERldmljZSgpID8gZS5jbGllbnRZIDogZS50b3VjaGVzWzBdLmNsaWVudFk7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLm1vdmUsIG9uTW92ZVRocm90dGxlZCk7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLnVwLCBvbk1vdmVTdG9wKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBvbkNvbGxhcHNlQnV0dG9uID0gKCkgPT4ge1xyXG4gICAgaWYgKG5ld1dpbmRvdy5jbGFzc0xpc3QuY29udGFpbnMoJ3dpbmRvdy0tY29sbGFwc2VkJykpIHtcclxuICAgICAgbmV3V2luZG93LmNsYXNzTGlzdC5yZW1vdmUoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgICAgIHNldEN1cnJlbnRXaW5kb3dBY3RpdmUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChyZWZlcmVuY2UgPT09IGxhc3RSZWZlcmVuY2UpIHtcclxuICAgICAgICBuZXdXaW5kb3cuY2xhc3NMaXN0LmFkZCgnd2luZG93LS1jb2xsYXBzZWQnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzZXRDdXJyZW50V2luZG93QWN0aXZlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBvbkV4cGFuZEJ1dHRvbiA9ICgpID0+IHtcclxuICAgIHNldEN1cnJlbnRXaW5kb3dBY3RpdmUocmVmZXJlbmNlLCBuZXdXaW5kb3cpO1xyXG4gICAgaWYgKG5ld1dpbmRvdy5jbGFzc0xpc3QuY29udGFpbnMoJ3dpbmRvdy0tZnVsbHNjcmVlbicpKSB7XHJcbiAgICAgIG5ld1dpbmRvdy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5kb3ctLWZ1bGxzY3JlZW4nKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG5ld1dpbmRvdy5jbGFzc0xpc3QuYWRkKCd3aW5kb3ctLWZ1bGxzY3JlZW4nKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBvbkNsb3NlQnV0dG9uID0gKCkgPT4ge1xyXG4gICAgZXZ0LnRhcmdldC5jbGFzc0xpc3QuYWRkKCdmaWxlJyk7XHJcbiAgICBldnQudGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGUtLW9wZW5lZCcpO1xyXG4gICAgc2V0Q3VycmVudFdpbmRvd0FjdGl2ZSgpO1xyXG4gICAgbmV3V2luZG93LnJlbW92ZSgpO1xyXG4gICAgcmVmZXJlbmNlLnJlbW92ZSgpO1xyXG4gICAgZmlsZUxhYmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGVfX2xhYmVsLS1hY3RpdmUnKTtcclxuICAgIGlmIChvZmZzZXRWZXJ0aWNhbENvdW50ZXIgPiAwKSB7XHJcbiAgICAgIG9mZnNldFZlcnRpY2FsQ291bnRlciAtPSAxO1xyXG4gICAgICBpbml0aWFsV2luZG93Q291bnRlclZlcnRpY2FsIC09IDMwO1xyXG4gICAgfVxyXG4gICAgaWYgKG9mZnNldEhvcml6b250YWxDb3VudGVyID4gMCkge1xyXG4gICAgICBvZmZzZXRIb3Jpem9udGFsQ291bnRlciAtPSAxO1xyXG4gICAgICBpbml0aWFsV2luZG93Q291bnRlckhvcml6b250YWwgLT0gMTA7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgcmVmZXJlbmNlSWNvbiA9IGV2dC50YXJnZXQucXVlcnlTZWxlY3RvcignLmZpbGVfX2ljb24nKS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgcmVmZXJlbmNlSWNvbi5jbGFzc0xpc3QucmVtb3ZlKCdmaWxlX19pY29uLS1kZXNrdG9wJyk7XHJcbiAgY29uc3QgcmVmZXJlbmNlVGV4dCA9IHJlZmVyZW5jZS5xdWVyeVNlbGVjdG9yKCcucmVmZXJlbmNlX190ZXh0Jyk7XHJcbiAgcmVmZXJlbmNlVGV4dC50ZXh0Q29udGVudCA9IGZpbGVOYW1lLnRleHRDb250ZW50O1xyXG4gIHJlZmVyZW5jZS5pbnNlcnRCZWZvcmUocmVmZXJlbmNlSWNvbiwgcmVmZXJlbmNlVGV4dCk7XHJcbiAgZGVza3RvcEZvb3Rlci5hcHBlbmRDaGlsZChyZWZlcmVuY2UpO1xyXG4gIHJlZmVyZW5jZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgb25Db2xsYXBzZUJ1dHRvbik7XHJcblxyXG4gIG5ld1dpbmRvdy5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5kb3duLCAoZSkgPT4ge1xyXG4gICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy53aW5kb3dfX2RyYWdnYWJsZS1hcmVhJykpIHtcclxuICAgICAgb25XaW5kb3dEcmFnKGUpO1xyXG4gICAgfVxyXG4gICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy53aW5kb3dfX2NvbnRlbnQnKSkge1xyXG4gICAgICBzZXRDdXJyZW50V2luZG93QWN0aXZlKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIG5ld1dpbmRvdy5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgKGUpID0+IHtcclxuICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCcud2luZG93X19idXR0b24tLWNvbGxhcHNlJykpIHtcclxuICAgICAgb25Db2xsYXBzZUJ1dHRvbigpO1xyXG4gICAgfVxyXG4gICAgaWYgKGUudGFyZ2V0LmNsb3Nlc3QoJy53aW5kb3dfX2J1dHRvbi0tY2xvc2UnKSkge1xyXG4gICAgICBvbkNsb3NlQnV0dG9uKCk7XHJcbiAgICB9XHJcbiAgICBpZiAoZS50YXJnZXQuY2xvc2VzdCgnLndpbmRvd19fYnV0dG9uLS1leHBhbmQnKSkge1xyXG4gICAgICBvbkV4cGFuZEJ1dHRvbigpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59O1xyXG5cclxuZGVza3RvcEZvb3Rlci5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIChldnQpID0+IHtcclxuICBldnQucHJldmVudERlZmF1bHQoKTtcclxuICBkZXNrdG9wRm9vdGVyLnNjcm9sbExlZnQgKz0gZXZ0LmRlbHRhWTtcclxufSk7XHJcblxyXG5kZXNrdG9wLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLmNsaWNrLCAoZXZ0KSA9PiB7XHJcbiAgaWYgKGV2dC50YXJnZXQuY2xvc2VzdCgnLmZpbGUnKSAmJiAhZXZ0LnRhcmdldC5jbG9zZXN0KCcuZmlsZS0tbGluaycpKSB7XHJcbiAgICBvbkZpbGVPcGVuKGV2dCk7XHJcbiAgfVxyXG59KTtcclxuIl0sImZpbGUiOiJ3aW5kb3cuanMifQ==