import{throttle}from"./throttle.js";import{events,isTouchDevice,deviceType}from"./checkDeviceType.js";isTouchDevice();const template=document.querySelector(".template"),desktop=document.querySelector(".desktop"),desktopFooter=desktop.querySelector(".desktop__footer"),windowTemplate=template.querySelector(".window"),fileList=document.querySelectorAll(".file"),referenceTemplate=template.querySelector(".reference");let lastFile,initialzIndex=0,initialX=0,initialY=0,moveElement=!1;desktopFooter.addEventListener("wheel",(e=>{e.preventDefault(),desktopFooter.scrollLeft+=e.deltaY}));const setStartPosition=e=>{e.classList.remove("window--collapsed"),e.style.left=desktop.offsetWidth/2+"px",e.style.top=desktop.offsetHeight/2+"px",e.style.width=`${Math.round(.7*window.innerWidth)}px`,e.style.height=`${Math.round(.7*window.innerHeight)}px`},setCurrentWindowActive=(e,t)=>{lastFile=t;const i=initialzIndex+1;e.style.zIndex=`${i}`,initialzIndex=i;desktop.querySelectorAll(".window").forEach((e=>{e.classList.remove("window--active")})),e.classList.add("window--active")},setCurrentReferenceActive=e=>{desktop.querySelectorAll(".reference").forEach((e=>{e.classList.remove("reference--active")})),e.classList.add("reference--active")};fileList.forEach((e=>{const t=throttle((function i(n){n.target.removeEventListener(events[deviceType].click,t);const o=n.target.querySelector(".file__name"),s=n.target.querySelector(".file__icon").cloneNode(!0),c=windowTemplate.cloneNode(!0),l=c.querySelector(".window__path"),r=c.querySelector(".window__draggable-area"),d=referenceTemplate.cloneNode(!0),a=n.target.querySelector(".file__content").cloneNode(!0),v=n.target.querySelector(".file__icon").cloneNode(!0);l.textContent=o.textContent,r.insertBefore(s,l),desktop.appendChild(c),p=c,p.classList.remove("window--collapsed"),p.style.left=desktop.offsetWidth/2+"px",p.style.top=desktop.offsetHeight/2+"px",p.style.width=`${Math.round(.7*window.innerWidth)}px`,p.style.height=`${Math.round(.7*window.innerHeight)}px`,setCurrentWindowActive(c,d),setCurrentReferenceActive(d);var p;const u=throttle((e=>{if(!0===moveElement){const t=isTouchDevice()?e.touches[0].clientX:e.clientX,i=isTouchDevice()?e.touches[0].clientY:e.clientY;c.style.left=c.offsetLeft-(initialX-t)+"px",c.style.top=c.offsetTop-(initialY-i)+"px",initialX=t,initialY=i}}),10),w=()=>{document.removeEventListener(events[deviceType].move,u),document.removeEventListener(events[deviceType].up,w),moveElement=!1};r.addEventListener(events[deviceType].down,(e=>{e.cancelable&&e.preventDefault(),c.classList.contains("window--fullscreen")||(moveElement=!0,initialX=isTouchDevice()?e.touches[0].clientX:e.clientX,initialY=isTouchDevice()?e.touches[0].clientY:e.clientY,document.addEventListener(events[deviceType].move,u),document.addEventListener(events[deviceType].up,w))})),c.addEventListener(events[deviceType].down,(()=>{setCurrentWindowActive(c,d),setCurrentReferenceActive(d)}));const f=()=>{setCurrentReferenceActive(d),c.classList.contains("window--collapsed")?(c.classList.remove("window--collapsed"),setCurrentWindowActive(c,d)):d===lastFile?c.classList.add("window--collapsed"):setCurrentWindowActive(c,d)};c.querySelector(".window__button--collapse").addEventListener(events[deviceType].click,f);const y=()=>{c.remove(),s.remove(),e.addEventListener(events[deviceType].click,i),d.remove(),a.remove(),v.remove()};c.querySelector(".window__button--close").addEventListener(events[deviceType].click,y);if(c.querySelector(".window__button--expand").addEventListener(events[deviceType].click,(()=>{c.classList.contains("window--fullscreen")?c.classList.remove("window--fullscreen"):c.classList.add("window--fullscreen")})),c.appendChild(a),a.classList.remove("visually-hidden"),a.classList.add("window__content"),a.classList.remove("file__content"),n.target.classList.contains("file--folder")){const e=c.querySelectorAll(".file");a.classList.add("window__content--folder"),e.forEach((e=>{e.addEventListener(events[deviceType].click,t)}))}const m=d.querySelector(".reference__text");m.textContent=o.textContent,d.insertBefore(v,m),desktopFooter.appendChild(d),d.addEventListener(events[deviceType].click,f)}),100);(e.classList.contains("file--text")||e.classList.contains("file--folder"))&&e.addEventListener(events[deviceType].click,t)}));