{"version":3,"names":[],"mappings":"","sources":["modules/note.js"],"sourcesContent":["import { throttle } from './throttle.js';\r\n\r\nlet deviceType = '';\r\n\r\nconst isTouchDevice = () => {\r\n  try {\r\n    document.createEvent('TouchEvent');\r\n    deviceType = 'touch';\r\n    return true;\r\n  } catch (err) {\r\n    deviceType = 'mouse';\r\n    return false;\r\n  }\r\n};\r\n\r\nisTouchDevice();\r\n\r\nconst events = {\r\n  mouse: {\r\n    down: 'mousedown',\r\n    move: 'mousemove',\r\n    up: 'mouseup',\r\n    click: 'click',\r\n  },\r\n  touch: {\r\n    down: 'touchstart',\r\n    move: 'touchmove',\r\n    up: 'touchend',\r\n    click: 'click',\r\n  },\r\n};\r\n\r\nlet initialX = 0;\r\nlet initialY = 0;\r\nlet initialzIndex = 0;\r\nlet moveElement = false;\r\nlet initialWindowCounterVertical = 0;\r\nlet initialWindowCounterHorisontal = 0;\r\nlet offsetVerticalCounter = 0;\r\nlet offsetHorisontalCounter = 0;\r\n\r\nconst template = document.querySelector('.template');\r\nconst referenceTemplate = template.querySelector('.reference');\r\nconst windowTemplate = template.querySelector('.window');\r\nconst desktop = document.querySelector('.desktop');\r\nconst desktopFooter = desktop.querySelector('.desktop__footer');\r\nconst desktopWrapper = desktop.querySelector('.desktop__wrapper');\r\n\r\nconst file = document.querySelector('.file');\r\nfor (let i = 0; i < 100; i++) {\r\n  const fileClone = file.cloneNode(true);\r\n  document.querySelector('.desktop__wrapper').appendChild(fileClone);\r\n}\r\n\r\nlet lastFile;\r\n\r\nconst fileList = document.querySelectorAll('.file');\r\n\r\nfileList.forEach((item) => {\r\n  console.log('fileList forEach');\r\n  const window = windowTemplate.cloneNode(true);\r\n  const windowDraggableArea = window.querySelector('.window__draggable-area');\r\n  const windowHeader = window.querySelector('.window__header');\r\n  const windowPath = window.querySelector('.window__path');\r\n  const windowButtonCollapse = window.querySelector('.window__button--collapse');\r\n  const windowButtonExpand = window.querySelector('.window__button--expand');\r\n  const windowButtonClose = window.querySelector('.window__button--close');\r\n  const fileLabel = item.querySelector('.file__label');\r\n  const reference = referenceTemplate.cloneNode(true);\r\n  const fileName = item.querySelector('.file__name');\r\n  const referenceText = reference.querySelector('.reference__text');\r\n  const referenceIcon = item.querySelector('.file__icon').cloneNode(true);\r\n  reference.insertBefore(referenceIcon, referenceText);\r\n  const pathIcon = item.querySelector('.file__icon').cloneNode(true);\r\n\r\n  if (window) {\r\n    windowDraggableArea.insertBefore(pathIcon, windowPath);\r\n    console.log('windowPath');\r\n  }\r\n\r\n  const placeOnTop = () => {\r\n    console.log('placeOnTop');\r\n    const newzIndex = initialzIndex + 1;\r\n    window.style.zIndex = `${newzIndex}`;\r\n    initialzIndex = newzIndex;\r\n    lastFile = reference;\r\n    const windowHeaderList = desktop.querySelectorAll('.window__header');\r\n    windowHeaderList.forEach((thing) => {\r\n      thing.classList.remove('window__header--active');\r\n    });\r\n    windowHeader.classList.add('window__header--active');\r\n  };\r\n\r\n  const setActive = () => {\r\n    console.log('setActive');\r\n    const referenceList = document.querySelectorAll('.reference');\r\n    referenceList.forEach((refernce) => {\r\n      refernce.classList.remove('reference--active');\r\n    });\r\n    reference.classList.add('reference--active');\r\n  };\r\n\r\n  const onCollapseButton = () => {\r\n    console.log('onCollapseButton');\r\n    setActive();\r\n    if (window.classList.contains('window--collapsed')) {\r\n      window.classList.remove('window--collapsed');\r\n      placeOnTop();\r\n      console.log(' containsonCollapseButton');\r\n    } else {\r\n      if (reference !== lastFile) {\r\n        console.log(' creference !== lastFile');\r\n        placeOnTop();\r\n      } else {\r\n        window.classList.add('window--collapsed');\r\n        console.log('window--collapse');\r\n      }\r\n    }\r\n  };\r\n\r\n  const onCloseButton = () => {\r\n    console.log('onCloseButton');\r\n    window.classList.add('window--collapsed');\r\n    fileLabel.classList.remove('file__label--active');\r\n    removeWindowListeners();\r\n    reference.remove();\r\n    window.remove();\r\n    fileLabel.addEventListener(events[deviceType].click, onFileOpen);\r\n    if (offsetVerticalCounter > 0) {\r\n      offsetVerticalCounter -= 1;\r\n      initialWindowCounterVertical -= 30;\r\n      console.log('offsetVerticalCounter');\r\n    }\r\n    if (offsetHorisontalCounter > 0) {\r\n      console.log('offsetHorisontalCounter');\r\n      offsetHorisontalCounter -= 1;\r\n      initialWindowCounterHorisontal -= 10;\r\n    }\r\n  };\r\n\r\n  const onExpandButton = () => {\r\n    console.log('onExpandButton');\r\n    window.classList.remove('window--collapsed');\r\n    window.classList.toggle('window--fullscreen');\r\n  };\r\n\r\n  const onWindowClick = () => {\r\n    console.log('onWindowClick');\r\n    setActive();\r\n    placeOnTop();\r\n  };\r\n\r\n  let i = 0;\r\n  const onMoveEvent = (evt) => {\r\n    console.log(i);\r\n    i += 1;\r\n    console.log('onMoveEvent');\r\n    if (moveElement) {\r\n      console.log('onMoveEvent moveElement');\r\n      const newX = !isTouchDevice() ? evt.clientX : evt.touches[0].clientX;\r\n      const newY = !isTouchDevice() ? evt.clientY : evt.touches[0].clientY;\r\n      window.style.left = `${window.offsetLeft - (initialX - newX)}px`;\r\n      window.style.top = `${window.offsetTop - (initialY - newY)}px`;\r\n      initialX = newX;\r\n      initialY = newY;\r\n    }\r\n  };\r\n\r\n  const onMoveThrottled = throttle(onMoveEvent, 10);\r\n\r\n  function stopMovement() {\r\n    console.log('stopMovement');\r\n    moveElement = false;\r\n    document.removeEventListener(events[deviceType].move, onMoveThrottled);\r\n    document.removeEventListener(events[deviceType].up, stopMovement);\r\n  }\r\n\r\n  const onWindowDrag = (evt) => {\r\n    console.log('onWindowDrag');\r\n    if (evt.cancelable) {\r\n      console.log('preventDefault');\r\n      evt.preventDefault();\r\n    }\r\n    if (!window.classList.contains('window--fullscreen')) {\r\n      console.log('contains(window--fullscreen))');\r\n      moveElement = true;\r\n      initialX = !isTouchDevice() ? evt.clientX : evt.touches[0].clientX;\r\n      initialY = !isTouchDevice() ? evt.clientY : evt.touches[0].clientY;\r\n      document.addEventListener(events[deviceType].move, onMoveThrottled);\r\n      document.addEventListener(events[deviceType].up, stopMovement);\r\n    }\r\n  };\r\n\r\n  if (fileLabel) {\r\n    fileLabel.addEventListener(events[deviceType].click, onFileOpen);\r\n    console.log('fileLabel');\r\n  }\r\n  function onFileOpen() {\r\n    console.log('onFileOpen');\r\n    if (item.classList.contains('file--text') || item.classList.contains('file--folder')) {\r\n      const fileContent = item.querySelector('.file__content');\r\n      if (fileContent) {\r\n        window.appendChild(fileContent);\r\n        fileContent.classList.remove('visually-hidden');\r\n        fileContent.classList.add('window__content');\r\n        fileContent.classList.remove('file__content');\r\n        if (item.classList.contains('file--folder')) {\r\n          fileContent.classList.add('window--folder');\r\n        }\r\n      }\r\n      desktop.appendChild(window);\r\n      window.classList.remove('window--collapsed');\r\n      fileLabel.classList.add('file__label--active');\r\n      window.style.left = `${desktop.offsetWidth / 2 + initialWindowCounterHorisontal}px`;\r\n      window.style.top = `${desktop.offsetHeight / 2 + initialWindowCounterVertical}px`;\r\n      if (initialWindowCounterHorisontal + (desktopWrapper.offsetWidth - window.offsetWidth) / 2 + 10 + window.offsetWidth >= desktopWrapper.offsetWidth) {\r\n        initialWindowCounterHorisontal = 0;\r\n        offsetHorisontalCounter = 0;\r\n        console.log(true, offsetHorisontalCounter);\r\n      } else {\r\n        initialWindowCounterHorisontal += 10;\r\n        offsetHorisontalCounter += 1;\r\n      }\r\n      if (initialWindowCounterVertical + (desktopWrapper.offsetHeight - window.offsetHeight) / 2 + 30 + window.offsetHeight >= desktopWrapper.offsetHeight) {\r\n        initialWindowCounterVertical = 0;\r\n        offsetVerticalCounter = 0;\r\n        console.log(true, offsetVerticalCounter);\r\n      } else {\r\n        initialWindowCounterVertical += 30;\r\n        offsetVerticalCounter += 1;\r\n      }\r\n      window.style.transform = 'translate(-50%, -50%)';\r\n      windowPath.textContent = `C:/${fileName.textContent}`;\r\n      referenceText.textContent = fileName.textContent;\r\n      reference.addEventListener('click', onCollapseButton);\r\n      reference.classList.add('reference--active');\r\n      desktopFooter.appendChild(reference);\r\n      fileLabel.removeEventListener(events[deviceType].click, onFileOpen);\r\n      stopMovement();\r\n      setActive();\r\n      placeOnTop();\r\n      if (window) {\r\n        addWindowListeners();\r\n      }\r\n    }\r\n  }\r\n  function addWindowListeners() {\r\n    console.log('addWindowListeners');\r\n    windowButtonCollapse.addEventListener(events[deviceType].click, onCollapseButton);\r\n    windowButtonClose.addEventListener(events[deviceType].click, onCloseButton);\r\n    windowButtonExpand.addEventListener(events[deviceType].click, onExpandButton);\r\n    window.addEventListener(events[deviceType].down, onWindowClick);\r\n    windowDraggableArea.addEventListener(events[deviceType].down, onWindowDrag);\r\n  }\r\n  function removeWindowListeners() {\r\n    console.log('removeWindowListeners');\r\n    windowButtonCollapse.removeEventListener(events[deviceType].click, onCollapseButton);\r\n    windowButtonClose.removeEventListener(events[deviceType].click, onCloseButton);\r\n    windowButtonExpand.removeEventListener(events[deviceType].click, onExpandButton);\r\n    window.removeEventListener(events[deviceType].down, onWindowClick);\r\n    windowDraggableArea.removeEventListener(events[deviceType].down, onWindowDrag);\r\n  }\r\n});\r\n\r\ndesktopFooter.addEventListener('wheel', (evt) => {\r\n  evt.preventDefault();\r\n  desktopFooter.scrollLeft += evt.deltaY;\r\n});\r\n"],"file":"note.js"}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtb2R1bGVzL25vdGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdGhyb3R0bGUgfSBmcm9tICcuL3Rocm90dGxlLmpzJztcclxuXHJcbmxldCBkZXZpY2VUeXBlID0gJyc7XHJcblxyXG5jb25zdCBpc1RvdWNoRGV2aWNlID0gKCkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBkb2N1bWVudC5jcmVhdGVFdmVudCgnVG91Y2hFdmVudCcpO1xyXG4gICAgZGV2aWNlVHlwZSA9ICd0b3VjaCc7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGRldmljZVR5cGUgPSAnbW91c2UnO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxufTtcclxuXHJcbmlzVG91Y2hEZXZpY2UoKTtcclxuXHJcbmNvbnN0IGV2ZW50cyA9IHtcclxuICBtb3VzZToge1xyXG4gICAgZG93bjogJ21vdXNlZG93bicsXHJcbiAgICBtb3ZlOiAnbW91c2Vtb3ZlJyxcclxuICAgIHVwOiAnbW91c2V1cCcsXHJcbiAgICBjbGljazogJ2NsaWNrJyxcclxuICB9LFxyXG4gIHRvdWNoOiB7XHJcbiAgICBkb3duOiAndG91Y2hzdGFydCcsXHJcbiAgICBtb3ZlOiAndG91Y2htb3ZlJyxcclxuICAgIHVwOiAndG91Y2hlbmQnLFxyXG4gICAgY2xpY2s6ICdjbGljaycsXHJcbiAgfSxcclxufTtcclxuXHJcbmxldCBpbml0aWFsWCA9IDA7XHJcbmxldCBpbml0aWFsWSA9IDA7XHJcbmxldCBpbml0aWFsekluZGV4ID0gMDtcclxubGV0IG1vdmVFbGVtZW50ID0gZmFsc2U7XHJcbmxldCBpbml0aWFsV2luZG93Q291bnRlclZlcnRpY2FsID0gMDtcclxubGV0IGluaXRpYWxXaW5kb3dDb3VudGVySG9yaXNvbnRhbCA9IDA7XHJcbmxldCBvZmZzZXRWZXJ0aWNhbENvdW50ZXIgPSAwO1xyXG5sZXQgb2Zmc2V0SG9yaXNvbnRhbENvdW50ZXIgPSAwO1xyXG5cclxuY29uc3QgdGVtcGxhdGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudGVtcGxhdGUnKTtcclxuY29uc3QgcmVmZXJlbmNlVGVtcGxhdGUgPSB0ZW1wbGF0ZS5xdWVyeVNlbGVjdG9yKCcucmVmZXJlbmNlJyk7XHJcbmNvbnN0IHdpbmRvd1RlbXBsYXRlID0gdGVtcGxhdGUucXVlcnlTZWxlY3RvcignLndpbmRvdycpO1xyXG5jb25zdCBkZXNrdG9wID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRlc2t0b3AnKTtcclxuY29uc3QgZGVza3RvcEZvb3RlciA9IGRlc2t0b3AucXVlcnlTZWxlY3RvcignLmRlc2t0b3BfX2Zvb3RlcicpO1xyXG5jb25zdCBkZXNrdG9wV3JhcHBlciA9IGRlc2t0b3AucXVlcnlTZWxlY3RvcignLmRlc2t0b3BfX3dyYXBwZXInKTtcclxuXHJcbmNvbnN0IGZpbGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZmlsZScpO1xyXG5mb3IgKGxldCBpID0gMDsgaSA8IDEwMDsgaSsrKSB7XHJcbiAgY29uc3QgZmlsZUNsb25lID0gZmlsZS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRlc2t0b3BfX3dyYXBwZXInKS5hcHBlbmRDaGlsZChmaWxlQ2xvbmUpO1xyXG59XHJcblxyXG5sZXQgbGFzdEZpbGU7XHJcblxyXG5jb25zdCBmaWxlTGlzdCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5maWxlJyk7XHJcblxyXG5maWxlTGlzdC5mb3JFYWNoKChpdGVtKSA9PiB7XHJcbiAgY29uc29sZS5sb2coJ2ZpbGVMaXN0IGZvckVhY2gnKTtcclxuICBjb25zdCB3aW5kb3cgPSB3aW5kb3dUZW1wbGF0ZS5jbG9uZU5vZGUodHJ1ZSk7XHJcbiAgY29uc3Qgd2luZG93RHJhZ2dhYmxlQXJlYSA9IHdpbmRvdy5xdWVyeVNlbGVjdG9yKCcud2luZG93X19kcmFnZ2FibGUtYXJlYScpO1xyXG4gIGNvbnN0IHdpbmRvd0hlYWRlciA9IHdpbmRvdy5xdWVyeVNlbGVjdG9yKCcud2luZG93X19oZWFkZXInKTtcclxuICBjb25zdCB3aW5kb3dQYXRoID0gd2luZG93LnF1ZXJ5U2VsZWN0b3IoJy53aW5kb3dfX3BhdGgnKTtcclxuICBjb25zdCB3aW5kb3dCdXR0b25Db2xsYXBzZSA9IHdpbmRvdy5xdWVyeVNlbGVjdG9yKCcud2luZG93X19idXR0b24tLWNvbGxhcHNlJyk7XHJcbiAgY29uc3Qgd2luZG93QnV0dG9uRXhwYW5kID0gd2luZG93LnF1ZXJ5U2VsZWN0b3IoJy53aW5kb3dfX2J1dHRvbi0tZXhwYW5kJyk7XHJcbiAgY29uc3Qgd2luZG93QnV0dG9uQ2xvc2UgPSB3aW5kb3cucXVlcnlTZWxlY3RvcignLndpbmRvd19fYnV0dG9uLS1jbG9zZScpO1xyXG4gIGNvbnN0IGZpbGVMYWJlbCA9IGl0ZW0ucXVlcnlTZWxlY3RvcignLmZpbGVfX2xhYmVsJyk7XHJcbiAgY29uc3QgcmVmZXJlbmNlID0gcmVmZXJlbmNlVGVtcGxhdGUuY2xvbmVOb2RlKHRydWUpO1xyXG4gIGNvbnN0IGZpbGVOYW1lID0gaXRlbS5xdWVyeVNlbGVjdG9yKCcuZmlsZV9fbmFtZScpO1xyXG4gIGNvbnN0IHJlZmVyZW5jZVRleHQgPSByZWZlcmVuY2UucXVlcnlTZWxlY3RvcignLnJlZmVyZW5jZV9fdGV4dCcpO1xyXG4gIGNvbnN0IHJlZmVyZW5jZUljb24gPSBpdGVtLnF1ZXJ5U2VsZWN0b3IoJy5maWxlX19pY29uJykuY2xvbmVOb2RlKHRydWUpO1xyXG4gIHJlZmVyZW5jZS5pbnNlcnRCZWZvcmUocmVmZXJlbmNlSWNvbiwgcmVmZXJlbmNlVGV4dCk7XHJcbiAgY29uc3QgcGF0aEljb24gPSBpdGVtLnF1ZXJ5U2VsZWN0b3IoJy5maWxlX19pY29uJykuY2xvbmVOb2RlKHRydWUpO1xyXG5cclxuICBpZiAod2luZG93KSB7XHJcbiAgICB3aW5kb3dEcmFnZ2FibGVBcmVhLmluc2VydEJlZm9yZShwYXRoSWNvbiwgd2luZG93UGF0aCk7XHJcbiAgICBjb25zb2xlLmxvZygnd2luZG93UGF0aCcpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcGxhY2VPblRvcCA9ICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdwbGFjZU9uVG9wJyk7XHJcbiAgICBjb25zdCBuZXd6SW5kZXggPSBpbml0aWFsekluZGV4ICsgMTtcclxuICAgIHdpbmRvdy5zdHlsZS56SW5kZXggPSBgJHtuZXd6SW5kZXh9YDtcclxuICAgIGluaXRpYWx6SW5kZXggPSBuZXd6SW5kZXg7XHJcbiAgICBsYXN0RmlsZSA9IHJlZmVyZW5jZTtcclxuICAgIGNvbnN0IHdpbmRvd0hlYWRlckxpc3QgPSBkZXNrdG9wLnF1ZXJ5U2VsZWN0b3JBbGwoJy53aW5kb3dfX2hlYWRlcicpO1xyXG4gICAgd2luZG93SGVhZGVyTGlzdC5mb3JFYWNoKCh0aGluZykgPT4ge1xyXG4gICAgICB0aGluZy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5kb3dfX2hlYWRlci0tYWN0aXZlJyk7XHJcbiAgICB9KTtcclxuICAgIHdpbmRvd0hlYWRlci5jbGFzc0xpc3QuYWRkKCd3aW5kb3dfX2hlYWRlci0tYWN0aXZlJyk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3Qgc2V0QWN0aXZlID0gKCkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ3NldEFjdGl2ZScpO1xyXG4gICAgY29uc3QgcmVmZXJlbmNlTGlzdCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZWZlcmVuY2UnKTtcclxuICAgIHJlZmVyZW5jZUxpc3QuZm9yRWFjaCgocmVmZXJuY2UpID0+IHtcclxuICAgICAgcmVmZXJuY2UuY2xhc3NMaXN0LnJlbW92ZSgncmVmZXJlbmNlLS1hY3RpdmUnKTtcclxuICAgIH0pO1xyXG4gICAgcmVmZXJlbmNlLmNsYXNzTGlzdC5hZGQoJ3JlZmVyZW5jZS0tYWN0aXZlJyk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3Qgb25Db2xsYXBzZUJ1dHRvbiA9ICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdvbkNvbGxhcHNlQnV0dG9uJyk7XHJcbiAgICBzZXRBY3RpdmUoKTtcclxuICAgIGlmICh3aW5kb3cuY2xhc3NMaXN0LmNvbnRhaW5zKCd3aW5kb3ctLWNvbGxhcHNlZCcpKSB7XHJcbiAgICAgIHdpbmRvdy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5kb3ctLWNvbGxhcHNlZCcpO1xyXG4gICAgICBwbGFjZU9uVG9wKCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKCcgY29udGFpbnNvbkNvbGxhcHNlQnV0dG9uJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAocmVmZXJlbmNlICE9PSBsYXN0RmlsZSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCcgY3JlZmVyZW5jZSAhPT0gbGFzdEZpbGUnKTtcclxuICAgICAgICBwbGFjZU9uVG9wKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgd2luZG93LmNsYXNzTGlzdC5hZGQoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ3dpbmRvdy0tY29sbGFwc2UnKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGNvbnN0IG9uQ2xvc2VCdXR0b24gPSAoKSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygnb25DbG9zZUJ1dHRvbicpO1xyXG4gICAgd2luZG93LmNsYXNzTGlzdC5hZGQoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgICBmaWxlTGFiZWwuY2xhc3NMaXN0LnJlbW92ZSgnZmlsZV9fbGFiZWwtLWFjdGl2ZScpO1xyXG4gICAgcmVtb3ZlV2luZG93TGlzdGVuZXJzKCk7XHJcbiAgICByZWZlcmVuY2UucmVtb3ZlKCk7XHJcbiAgICB3aW5kb3cucmVtb3ZlKCk7XHJcbiAgICBmaWxlTGFiZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0uY2xpY2ssIG9uRmlsZU9wZW4pO1xyXG4gICAgaWYgKG9mZnNldFZlcnRpY2FsQ291bnRlciA+IDApIHtcclxuICAgICAgb2Zmc2V0VmVydGljYWxDb3VudGVyIC09IDE7XHJcbiAgICAgIGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWwgLT0gMzA7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdvZmZzZXRWZXJ0aWNhbENvdW50ZXInKTtcclxuICAgIH1cclxuICAgIGlmIChvZmZzZXRIb3Jpc29udGFsQ291bnRlciA+IDApIHtcclxuICAgICAgY29uc29sZS5sb2coJ29mZnNldEhvcmlzb250YWxDb3VudGVyJyk7XHJcbiAgICAgIG9mZnNldEhvcmlzb250YWxDb3VudGVyIC09IDE7XHJcbiAgICAgIGluaXRpYWxXaW5kb3dDb3VudGVySG9yaXNvbnRhbCAtPSAxMDtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBvbkV4cGFuZEJ1dHRvbiA9ICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdvbkV4cGFuZEJ1dHRvbicpO1xyXG4gICAgd2luZG93LmNsYXNzTGlzdC5yZW1vdmUoJ3dpbmRvdy0tY29sbGFwc2VkJyk7XHJcbiAgICB3aW5kb3cuY2xhc3NMaXN0LnRvZ2dsZSgnd2luZG93LS1mdWxsc2NyZWVuJyk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3Qgb25XaW5kb3dDbGljayA9ICgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdvbldpbmRvd0NsaWNrJyk7XHJcbiAgICBzZXRBY3RpdmUoKTtcclxuICAgIHBsYWNlT25Ub3AoKTtcclxuICB9O1xyXG5cclxuICBsZXQgaSA9IDA7XHJcbiAgY29uc3Qgb25Nb3ZlRXZlbnQgPSAoZXZ0KSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZyhpKTtcclxuICAgIGkgKz0gMTtcclxuICAgIGNvbnNvbGUubG9nKCdvbk1vdmVFdmVudCcpO1xyXG4gICAgaWYgKG1vdmVFbGVtZW50KSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdvbk1vdmVFdmVudCBtb3ZlRWxlbWVudCcpO1xyXG4gICAgICBjb25zdCBuZXdYID0gIWlzVG91Y2hEZXZpY2UoKSA/IGV2dC5jbGllbnRYIDogZXZ0LnRvdWNoZXNbMF0uY2xpZW50WDtcclxuICAgICAgY29uc3QgbmV3WSA9ICFpc1RvdWNoRGV2aWNlKCkgPyBldnQuY2xpZW50WSA6IGV2dC50b3VjaGVzWzBdLmNsaWVudFk7XHJcbiAgICAgIHdpbmRvdy5zdHlsZS5sZWZ0ID0gYCR7d2luZG93Lm9mZnNldExlZnQgLSAoaW5pdGlhbFggLSBuZXdYKX1weGA7XHJcbiAgICAgIHdpbmRvdy5zdHlsZS50b3AgPSBgJHt3aW5kb3cub2Zmc2V0VG9wIC0gKGluaXRpYWxZIC0gbmV3WSl9cHhgO1xyXG4gICAgICBpbml0aWFsWCA9IG5ld1g7XHJcbiAgICAgIGluaXRpYWxZID0gbmV3WTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBvbk1vdmVUaHJvdHRsZWQgPSB0aHJvdHRsZShvbk1vdmVFdmVudCwgMTApO1xyXG5cclxuICBmdW5jdGlvbiBzdG9wTW92ZW1lbnQoKSB7XHJcbiAgICBjb25zb2xlLmxvZygnc3RvcE1vdmVtZW50Jyk7XHJcbiAgICBtb3ZlRWxlbWVudCA9IGZhbHNlO1xyXG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0ubW92ZSwgb25Nb3ZlVGhyb3R0bGVkKTtcclxuICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLnVwLCBzdG9wTW92ZW1lbnQpO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgb25XaW5kb3dEcmFnID0gKGV2dCkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ29uV2luZG93RHJhZycpO1xyXG4gICAgaWYgKGV2dC5jYW5jZWxhYmxlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdwcmV2ZW50RGVmYXVsdCcpO1xyXG4gICAgICBldnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIH1cclxuICAgIGlmICghd2luZG93LmNsYXNzTGlzdC5jb250YWlucygnd2luZG93LS1mdWxsc2NyZWVuJykpIHtcclxuICAgICAgY29uc29sZS5sb2coJ2NvbnRhaW5zKHdpbmRvdy0tZnVsbHNjcmVlbikpJyk7XHJcbiAgICAgIG1vdmVFbGVtZW50ID0gdHJ1ZTtcclxuICAgICAgaW5pdGlhbFggPSAhaXNUb3VjaERldmljZSgpID8gZXZ0LmNsaWVudFggOiBldnQudG91Y2hlc1swXS5jbGllbnRYO1xyXG4gICAgICBpbml0aWFsWSA9ICFpc1RvdWNoRGV2aWNlKCkgPyBldnQuY2xpZW50WSA6IGV2dC50b3VjaGVzWzBdLmNsaWVudFk7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLm1vdmUsIG9uTW92ZVRocm90dGxlZCk7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLnVwLCBzdG9wTW92ZW1lbnQpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGlmIChmaWxlTGFiZWwpIHtcclxuICAgIGZpbGVMYWJlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgb25GaWxlT3Blbik7XHJcbiAgICBjb25zb2xlLmxvZygnZmlsZUxhYmVsJyk7XHJcbiAgfVxyXG4gIGZ1bmN0aW9uIG9uRmlsZU9wZW4oKSB7XHJcbiAgICBjb25zb2xlLmxvZygnb25GaWxlT3BlbicpO1xyXG4gICAgaWYgKGl0ZW0uY2xhc3NMaXN0LmNvbnRhaW5zKCdmaWxlLS10ZXh0JykgfHwgaXRlbS5jbGFzc0xpc3QuY29udGFpbnMoJ2ZpbGUtLWZvbGRlcicpKSB7XHJcbiAgICAgIGNvbnN0IGZpbGVDb250ZW50ID0gaXRlbS5xdWVyeVNlbGVjdG9yKCcuZmlsZV9fY29udGVudCcpO1xyXG4gICAgICBpZiAoZmlsZUNvbnRlbnQpIHtcclxuICAgICAgICB3aW5kb3cuYXBwZW5kQ2hpbGQoZmlsZUNvbnRlbnQpO1xyXG4gICAgICAgIGZpbGVDb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoJ3Zpc3VhbGx5LWhpZGRlbicpO1xyXG4gICAgICAgIGZpbGVDb250ZW50LmNsYXNzTGlzdC5hZGQoJ3dpbmRvd19fY29udGVudCcpO1xyXG4gICAgICAgIGZpbGVDb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2ZpbGVfX2NvbnRlbnQnKTtcclxuICAgICAgICBpZiAoaXRlbS5jbGFzc0xpc3QuY29udGFpbnMoJ2ZpbGUtLWZvbGRlcicpKSB7XHJcbiAgICAgICAgICBmaWxlQ29udGVudC5jbGFzc0xpc3QuYWRkKCd3aW5kb3ctLWZvbGRlcicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBkZXNrdG9wLmFwcGVuZENoaWxkKHdpbmRvdyk7XHJcbiAgICAgIHdpbmRvdy5jbGFzc0xpc3QucmVtb3ZlKCd3aW5kb3ctLWNvbGxhcHNlZCcpO1xyXG4gICAgICBmaWxlTGFiZWwuY2xhc3NMaXN0LmFkZCgnZmlsZV9fbGFiZWwtLWFjdGl2ZScpO1xyXG4gICAgICB3aW5kb3cuc3R5bGUubGVmdCA9IGAke2Rlc2t0b3Aub2Zmc2V0V2lkdGggLyAyICsgaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpc29udGFsfXB4YDtcclxuICAgICAgd2luZG93LnN0eWxlLnRvcCA9IGAke2Rlc2t0b3Aub2Zmc2V0SGVpZ2h0IC8gMiArIGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWx9cHhgO1xyXG4gICAgICBpZiAoaW5pdGlhbFdpbmRvd0NvdW50ZXJIb3Jpc29udGFsICsgKGRlc2t0b3BXcmFwcGVyLm9mZnNldFdpZHRoIC0gd2luZG93Lm9mZnNldFdpZHRoKSAvIDIgKyAxMCArIHdpbmRvdy5vZmZzZXRXaWR0aCA+PSBkZXNrdG9wV3JhcHBlci5vZmZzZXRXaWR0aCkge1xyXG4gICAgICAgIGluaXRpYWxXaW5kb3dDb3VudGVySG9yaXNvbnRhbCA9IDA7XHJcbiAgICAgICAgb2Zmc2V0SG9yaXNvbnRhbENvdW50ZXIgPSAwO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHRydWUsIG9mZnNldEhvcmlzb250YWxDb3VudGVyKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpbml0aWFsV2luZG93Q291bnRlckhvcmlzb250YWwgKz0gMTA7XHJcbiAgICAgICAgb2Zmc2V0SG9yaXNvbnRhbENvdW50ZXIgKz0gMTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoaW5pdGlhbFdpbmRvd0NvdW50ZXJWZXJ0aWNhbCArIChkZXNrdG9wV3JhcHBlci5vZmZzZXRIZWlnaHQgLSB3aW5kb3cub2Zmc2V0SGVpZ2h0KSAvIDIgKyAzMCArIHdpbmRvdy5vZmZzZXRIZWlnaHQgPj0gZGVza3RvcFdyYXBwZXIub2Zmc2V0SGVpZ2h0KSB7XHJcbiAgICAgICAgaW5pdGlhbFdpbmRvd0NvdW50ZXJWZXJ0aWNhbCA9IDA7XHJcbiAgICAgICAgb2Zmc2V0VmVydGljYWxDb3VudGVyID0gMDtcclxuICAgICAgICBjb25zb2xlLmxvZyh0cnVlLCBvZmZzZXRWZXJ0aWNhbENvdW50ZXIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGluaXRpYWxXaW5kb3dDb3VudGVyVmVydGljYWwgKz0gMzA7XHJcbiAgICAgICAgb2Zmc2V0VmVydGljYWxDb3VudGVyICs9IDE7XHJcbiAgICAgIH1cclxuICAgICAgd2luZG93LnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoLTUwJSwgLTUwJSknO1xyXG4gICAgICB3aW5kb3dQYXRoLnRleHRDb250ZW50ID0gYEM6LyR7ZmlsZU5hbWUudGV4dENvbnRlbnR9YDtcclxuICAgICAgcmVmZXJlbmNlVGV4dC50ZXh0Q29udGVudCA9IGZpbGVOYW1lLnRleHRDb250ZW50O1xyXG4gICAgICByZWZlcmVuY2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkNvbGxhcHNlQnV0dG9uKTtcclxuICAgICAgcmVmZXJlbmNlLmNsYXNzTGlzdC5hZGQoJ3JlZmVyZW5jZS0tYWN0aXZlJyk7XHJcbiAgICAgIGRlc2t0b3BGb290ZXIuYXBwZW5kQ2hpbGQocmVmZXJlbmNlKTtcclxuICAgICAgZmlsZUxhYmVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLmNsaWNrLCBvbkZpbGVPcGVuKTtcclxuICAgICAgc3RvcE1vdmVtZW50KCk7XHJcbiAgICAgIHNldEFjdGl2ZSgpO1xyXG4gICAgICBwbGFjZU9uVG9wKCk7XHJcbiAgICAgIGlmICh3aW5kb3cpIHtcclxuICAgICAgICBhZGRXaW5kb3dMaXN0ZW5lcnMoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBmdW5jdGlvbiBhZGRXaW5kb3dMaXN0ZW5lcnMoKSB7XHJcbiAgICBjb25zb2xlLmxvZygnYWRkV2luZG93TGlzdGVuZXJzJyk7XHJcbiAgICB3aW5kb3dCdXR0b25Db2xsYXBzZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgb25Db2xsYXBzZUJ1dHRvbik7XHJcbiAgICB3aW5kb3dCdXR0b25DbG9zZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5jbGljaywgb25DbG9zZUJ1dHRvbik7XHJcbiAgICB3aW5kb3dCdXR0b25FeHBhbmQuYWRkRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0uY2xpY2ssIG9uRXhwYW5kQnV0dG9uKTtcclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tkZXZpY2VUeXBlXS5kb3duLCBvbldpbmRvd0NsaWNrKTtcclxuICAgIHdpbmRvd0RyYWdnYWJsZUFyZWEuYWRkRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0uZG93biwgb25XaW5kb3dEcmFnKTtcclxuICB9XHJcbiAgZnVuY3Rpb24gcmVtb3ZlV2luZG93TGlzdGVuZXJzKCkge1xyXG4gICAgY29uc29sZS5sb2coJ3JlbW92ZVdpbmRvd0xpc3RlbmVycycpO1xyXG4gICAgd2luZG93QnV0dG9uQ29sbGFwc2UucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0uY2xpY2ssIG9uQ29sbGFwc2VCdXR0b24pO1xyXG4gICAgd2luZG93QnV0dG9uQ2xvc2UucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0uY2xpY2ssIG9uQ2xvc2VCdXR0b24pO1xyXG4gICAgd2luZG93QnV0dG9uRXhwYW5kLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLmNsaWNrLCBvbkV4cGFuZEJ1dHRvbik7XHJcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudHNbZGV2aWNlVHlwZV0uZG93biwgb25XaW5kb3dDbGljayk7XHJcbiAgICB3aW5kb3dEcmFnZ2FibGVBcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2RldmljZVR5cGVdLmRvd24sIG9uV2luZG93RHJhZyk7XHJcbiAgfVxyXG59KTtcclxuXHJcbmRlc2t0b3BGb290ZXIuYWRkRXZlbnRMaXN0ZW5lcignd2hlZWwnLCAoZXZ0KSA9PiB7XHJcbiAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgZGVza3RvcEZvb3Rlci5zY3JvbGxMZWZ0ICs9IGV2dC5kZWx0YVk7XHJcbn0pO1xyXG4iXSwiZmlsZSI6Im5vdGUuanMifQ==