import{throttle}from"./throttle.js";import{isTouchDevice,deviceType}from"./checkDeviceType.js";isTouchDevice();const events={mouse:{down:"mousedown",move:"mousemove",up:"mouseup",click:"click"},touch:{down:"touchstart",move:"touchmove",up:"touchend",click:"click"}},template=document.querySelector(".template"),desktop=document.querySelector(".desktop"),desktopFooter=desktop.querySelector(".desktop__footer"),windowTemplate=template.querySelector(".window"),referenceTemplate=template.querySelector(".reference"),desktopWidth=desktop.offsetWidth,desktopHeight=desktop.offsetHeight,halfDesktopWidth=desktopWidth/2,halfDesktopHeight=desktopHeight/2,coefficientWidth=()=>desktopWidth<500?.9:.5,coefficientHeight=()=>desktopWidth<500?.7:.5,windowWidth=Math.round(window.innerWidth*(desktopWidth<500?.9:.5)),windowHeight=Math.round(window.innerHeight*(desktopWidth<500?.7:.5)),textIconTemplate=template.querySelector(".file__icon--text"),linkIconTemplate=template.querySelector(".file__icon--link"),folderIconTemplate=template.querySelector(".file__icon--folder"),fileList=document.querySelectorAll(".file"),setIcon=e=>e.classList.contains("file--text")?textIconTemplate:e.classList.contains("file--link")?linkIconTemplate:e.classList.contains("file--folder")?folderIconTemplate:void 0;fileList.forEach((e=>{const t=(i=e,i.classList.contains("file--text")?textIconTemplate:i.classList.contains("file--link")?linkIconTemplate:i.classList.contains("file--folder")?folderIconTemplate:void 0).cloneNode(!0);var i;const o=e.querySelector(".file__label"),n=e.querySelector(".file__name");o.insertBefore(t,n)}));let lastReference,initialIndex=0,initialX=0,initialY=0,moveElement=!1,initialWindowCounterVertical=0,initialWindowCounterHorizontal=0,offsetVerticalCounter=0,offsetHorizontalCounter=0;const setStartPosition=e=>{e.classList.remove("window--collapsed"),e.style.left=`${halfDesktopWidth+initialWindowCounterHorizontal}px`,e.style.top=`${halfDesktopHeight+initialWindowCounterVertical}px`,e.style.width=`${windowWidth}px`,e.style.height=`${windowHeight}px`,initialWindowCounterHorizontal+(desktopWidth-windowWidth)/2+10+windowWidth>=desktopWidth?(initialWindowCounterHorizontal=0,offsetHorizontalCounter=0):(initialWindowCounterHorizontal+=8,offsetHorizontalCounter+=1),initialWindowCounterVertical+(desktopHeight-windowHeight)/2+30+windowHeight>=desktopHeight?(initialWindowCounterVertical=0,offsetVerticalCounter=0):(initialWindowCounterVertical+=40,offsetVerticalCounter+=1)},onFileOpen=e=>{e.preventDefault(),e.target.classList.remove("file"),e.target.classList.add("file--opened");const t=e.target.querySelector(".file__label"),i=e.target.querySelector(".file__name"),o=e.target.querySelector(".file__icon").cloneNode(!0);o.classList.remove("file__icon--desktop");const n=windowTemplate.cloneNode(!0),l=n.querySelector(".window__path"),s=n.querySelector(".window__header").querySelector(".window__draggable-area"),c=referenceTemplate.cloneNode(!0);var r;l.textContent=i.textContent,s.insertBefore(o,l),desktop.appendChild(n),(r=n).classList.remove("window--collapsed"),r.style.left=`${halfDesktopWidth+initialWindowCounterHorizontal}px`,r.style.top=`${halfDesktopHeight+initialWindowCounterVertical}px`,r.style.width=`${windowWidth}px`,r.style.height=`${windowHeight}px`,initialWindowCounterHorizontal+(desktopWidth-windowWidth)/2+10+windowWidth>=desktopWidth?(initialWindowCounterHorizontal=0,offsetHorizontalCounter=0):(initialWindowCounterHorizontal+=8,offsetHorizontalCounter+=1),initialWindowCounterVertical+(desktopHeight-windowHeight)/2+30+windowHeight>=desktopHeight?(initialWindowCounterVertical=0,offsetVerticalCounter=0):(initialWindowCounterVertical+=40,offsetVerticalCounter+=1),t.classList.add("file__label--active");const a=e.target.querySelector(".file__content").cloneNode(!0);n.appendChild(a),a.classList.remove("visually-hidden"),a.classList.add("window__content"),a.classList.remove("file__content"),e.target.classList.contains("file--folder")&&a.classList.add("grid--folder");const d=()=>{lastReference=c;const e=initialIndex+1;n.style.zIndex=`${e}`,initialIndex=e,c.classList.add("reference--active"),desktop.querySelectorAll(".window--active").forEach((e=>{e.classList.remove("window--active")})),n.classList.add("window--active"),desktop.querySelectorAll(".reference").forEach((e=>{e===lastReference?e.classList.add("reference--active"):e.classList.remove("reference--active")}))};d();const f=throttle((e=>{if(moveElement){e.stopPropagation();const t=isTouchDevice()?e.touches[0].clientX:e.clientX,i=isTouchDevice()?e.touches[0].clientY:e.clientY,o=initialX-t,l=initialY-i,s=n.offsetLeft-o+"px",c=n.offsetTop-l+"px";n.style.left=s,n.style.top=c,initialX=t,initialY=i}}),10),p=()=>{document.removeEventListener(events[deviceType].move,f),document.removeEventListener(events[deviceType].up,p),moveElement=!1},w=()=>{n.classList.contains("window--collapsed")?(n.classList.remove("window--collapsed"),d()):c===lastReference?n.classList.add("window--collapsed"):d()},u=e.target.querySelector(".file__icon").cloneNode(!0);u.classList.remove("file__icon--desktop");const h=c.querySelector(".reference__text");h.textContent=i.textContent,c.insertBefore(u,h),desktopFooter.appendChild(c),c.addEventListener(events[deviceType].click,w),n.addEventListener(events[deviceType].down,(e=>{e.target.closest(".window__draggable-area")&&(e=>{d(),e.stopPropagation(),e.cancelable&&e.preventDefault(),n.classList.contains("window--fullscreen")||(moveElement=!0,initialX=isTouchDevice()?e.touches[0].clientX:e.clientX,initialY=isTouchDevice()?e.touches[0].clientY:e.clientY,document.addEventListener(events[deviceType].move,f),document.addEventListener(events[deviceType].up,p))})(e),e.target.closest(".window")&&d()})),n.addEventListener(events[deviceType].click,(i=>{i.target.closest(".window__button--collapse")&&w(),i.target.closest(".window__button--close")&&(e.target.classList.add("file"),e.target.classList.remove("file--opened"),d(),n.remove(),c.remove(),t.classList.remove("file__label--active"),offsetVerticalCounter>0&&(offsetVerticalCounter-=1,initialWindowCounterVertical-=40),offsetHorizontalCounter>0&&(offsetHorizontalCounter-=1,initialWindowCounterHorizontal-=10)),i.target.closest(".window__button--expand")&&(d(),n.classList.contains("window--fullscreen")?n.classList.remove("window--fullscreen"):n.classList.add("window--fullscreen"))}))};desktopFooter.addEventListener("wheel",(e=>{e.preventDefault(),desktopFooter.scrollLeft+=e.deltaY})),desktop.addEventListener(events[deviceType].click,(e=>{e.target.closest(".file")&&!e.target.closest(".file--link")&&onFileOpen(e)}));