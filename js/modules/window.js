import{throttle}from"./throttle.js";import{events,isTouchDevice,deviceType}from"./checkDeviceType.js";isTouchDevice();const template=document.querySelector(".template"),desktop=document.querySelector(".desktop"),desktopFooter=desktop.querySelector(".desktop__footer"),windowTemplate=template.querySelector(".window"),fileList=document.querySelectorAll(".file"),referenceTemplate=template.querySelector(".reference");let lastFile,initialzIndex=0,initialX=0,initialY=0,moveElement=!1,initialWindowCounterVertical=0,initialWindowCounterHorisontal=0,offsetVerticalCounter=0,offsetHorisontalCounter=0;desktopFooter.addEventListener("wheel",(e=>{e.preventDefault(),desktopFooter.scrollLeft+=e.deltaY}));const setStartPosition=e=>{e.classList.remove("window--collapsed"),e.style.left=`${desktop.offsetWidth/2+initialWindowCounterHorisontal}px`,e.style.top=`${desktop.offsetHeight/2+initialWindowCounterVertical}px`,e.style.width=`${Math.round(.7*window.innerWidth)}px`,e.style.height=`${Math.round(.7*window.innerHeight)}px`,initialWindowCounterHorisontal+(desktop.offsetWidth-e.offsetWidth)/2+10+e.offsetWidth>=desktop.offsetWidth?(initialWindowCounterHorisontal=0,offsetHorisontalCounter=0):(initialWindowCounterHorisontal+=10,offsetHorisontalCounter+=1),initialWindowCounterVertical+(desktop.offsetHeight-e.offsetHeight)/2+30+e.offsetHeight>=desktop.offsetHeight?(initialWindowCounterVertical=0,offsetVerticalCounter=0):(initialWindowCounterVertical+=30,offsetVerticalCounter+=1)},setCurrentReferenceActive=e=>{desktop.querySelectorAll(".reference").forEach((e=>{e.classList.remove("reference--active")})),e.classList.add("reference--active")};fileList.forEach((e=>{const t=throttle((function(i){i.target.removeEventListener(events[deviceType].click,t);const o=i.target.querySelector(".file__name"),n=i.target.querySelector(".file__icon").cloneNode(!0),s=windowTemplate.cloneNode(!0),l=s.querySelector(".window__path"),r=s.querySelector(".window__draggable-area"),c=referenceTemplate.cloneNode(!0),d=i.target.querySelector(".file__content").cloneNode(!0),a=i.target.querySelector(".file__icon").cloneNode(!0);l.textContent=o.textContent,r.insertBefore(n,l),desktop.appendChild(s),f=s,f.classList.remove("window--collapsed"),f.style.left=`${desktop.offsetWidth/2+initialWindowCounterHorisontal}px`,f.style.top=`${desktop.offsetHeight/2+initialWindowCounterVertical}px`,f.style.width=`${Math.round(.7*window.innerWidth)}px`,f.style.height=`${Math.round(.7*window.innerHeight)}px`,initialWindowCounterHorisontal+(desktop.offsetWidth-f.offsetWidth)/2+10+f.offsetWidth>=desktop.offsetWidth?(initialWindowCounterHorisontal=0,offsetHorisontalCounter=0):(initialWindowCounterHorisontal+=10,offsetHorisontalCounter+=1),initialWindowCounterVertical+(desktop.offsetHeight-f.offsetHeight)/2+30+f.offsetHeight>=desktop.offsetHeight?(initialWindowCounterVertical=0,offsetVerticalCounter=0):(initialWindowCounterVertical+=30,offsetVerticalCounter+=1),setCurrentReferenceActive(c);var f;const v=throttle((e=>{if(!0===moveElement){const t=isTouchDevice()?e.touches[0].clientX:e.clientX,i=isTouchDevice()?e.touches[0].clientY:e.clientY;s.style.left=s.offsetLeft-(initialX-t)+"px",s.style.top=s.offsetTop-(initialY-i)+"px",initialX=t,initialY=i}})),u=()=>{document.removeEventListener(events[deviceType].move,v),document.removeEventListener(events[deviceType].up,u),moveElement=!1},p=e=>{e.cancelable&&e.preventDefault(),s.classList.contains("window--fullscreen")||(moveElement=!0,initialX=isTouchDevice()?e.touches[0].clientX:e.clientX,initialY=isTouchDevice()?e.touches[0].clientY:e.clientY,document.addEventListener(events[deviceType].move,v),document.addEventListener(events[deviceType].up,u))},w=()=>{setCurrentReferenceActive(c),s.classList.contains("window--collapsed")?(s.classList.remove("window--collapsed"),_()):c===lastFile?s.classList.add("window--collapsed"):_()},h=()=>{s.remove(),n.remove(),e.addEventListener(events[deviceType].click,t),c.remove(),d.remove(),a.remove(),offsetVerticalCounter>0&&(offsetVerticalCounter-=1,initialWindowCounterVertical-=30),offsetHorisontalCounter>0&&(offsetHorisontalCounter-=1,initialWindowCounterHorisontal-=10)},y=()=>{s.classList.contains("window--fullscreen")?s.classList.remove("window--fullscreen"):s.classList.add("window--fullscreen")},m=s.querySelector(".window__button--expand"),C=s.querySelector(".window__button--close"),L=s.querySelector(".window__button--collapse");function _(){lastFile=c;const e=initialzIndex+1;s.style.zIndex=`${e}`,initialzIndex=e;desktop.querySelectorAll(".window").forEach((e=>{e.classList.remove("window--active"),e.querySelector(".window__draggable-area").removeEventListener(events[deviceType].down,p),e.querySelector(".window__button--collapse").removeEventListener(events[deviceType].click,w),e.querySelector(".window__button--close").removeEventListener(events[deviceType].click,h),e.querySelector(".window__button--expand").removeEventListener(events[deviceType].click,y)})),r.addEventListener(events[deviceType].down,p),L.addEventListener(events[deviceType].click,w),C.addEventListener(events[deviceType].click,h),m.addEventListener(events[deviceType].click,y),s.classList.add("window--active")}if(_(),s.addEventListener(events[deviceType].down,(()=>{_(),setCurrentReferenceActive(c)})),s.appendChild(d),d.classList.remove("visually-hidden"),d.classList.add("window__content"),d.classList.remove("file__content"),i.target.classList.contains("file--folder")){const e=s.querySelectorAll(".file");d.classList.add("window__content--folder"),e.forEach((e=>{e.addEventListener(events[deviceType].click,t)}))}const k=c.querySelector(".reference__text");k.textContent=o.textContent,c.insertBefore(a,k),desktopFooter.appendChild(c),c.addEventListener(events[deviceType].click,w)}),100);(e.classList.contains("file--text")||e.classList.contains("file--folder"))&&e.addEventListener(events[deviceType].click,t)}));