import{throttle}from"./throttle.js";import{events,isTouchDevice,deviceType}from"./checkDeviceType.js";isTouchDevice();const template=document.querySelector(".template"),desktop=document.querySelector(".desktop"),desktopFooter=desktop.querySelector(".desktop__footer"),windowTemplate=template.querySelector(".window"),referenceTemplate=template.querySelector(".reference"),desktopWidth=desktop.offsetWidth,desktopHeight=desktop.offsetHeight,halfDesktopWidth=desktopWidth/2,halfDesktopHeight=desktopHeight/2,windowWidth=Math.round(.7*window.innerWidth),windowHeight=Math.round(.7*window.innerHeight);let lastReference,initialzIndex=0,initialX=0,initialY=0,moveElement=!1,initialWindowCounterVertical=0,initialWindowCounterHorisontal=0,offsetVerticalCounter=0,offsetHorisontalCounter=0;const setStartPosition=e=>{e.classList.remove("window--collapsed"),e.style.left=`${halfDesktopWidth+initialWindowCounterHorisontal}px`,e.style.top=`${halfDesktopHeight+initialWindowCounterVertical}px`,e.style.width=`${windowWidth}px`,e.style.height=`${windowHeight}px`,initialWindowCounterHorisontal+(desktopWidth-windowWidth)/2+10+windowWidth>=desktopWidth?(initialWindowCounterHorisontal=0,offsetHorisontalCounter=0):(initialWindowCounterHorisontal+=10,offsetHorisontalCounter+=1),initialWindowCounterVertical+(desktopHeight-windowHeight)/2+30+windowHeight>=desktopHeight?(initialWindowCounterVertical=0,offsetVerticalCounter=0):(initialWindowCounterVertical+=30,offsetVerticalCounter+=1)},onFileOpen=e=>{e.target.classList.remove("file"),e.target.classList.add("file--opened");const t=e.target.querySelector(".file__label"),i=e.target.querySelector(".file__name"),o=e.target.querySelector(".file__icon").cloneNode(!0),n=windowTemplate.cloneNode(!0),l=n.querySelector(".window__path"),s=n.querySelector(".window__header").querySelector(".window__draggable-area"),r=referenceTemplate.cloneNode(!0);var a;l.textContent=i.textContent,s.insertBefore(o,l),desktop.appendChild(n),(a=n).classList.remove("window--collapsed"),a.style.left=`${halfDesktopWidth+initialWindowCounterHorisontal}px`,a.style.top=`${halfDesktopHeight+initialWindowCounterVertical}px`,a.style.width=`${windowWidth}px`,a.style.height=`${windowHeight}px`,initialWindowCounterHorisontal+(desktopWidth-windowWidth)/2+10+windowWidth>=desktopWidth?(initialWindowCounterHorisontal=0,offsetHorisontalCounter=0):(initialWindowCounterHorisontal+=10,offsetHorisontalCounter+=1),initialWindowCounterVertical+(desktopHeight-windowHeight)/2+30+windowHeight>=desktopHeight?(initialWindowCounterVertical=0,offsetVerticalCounter=0):(initialWindowCounterVertical+=30,offsetVerticalCounter+=1),t.classList.add("file__label--active");const d=e.target.querySelector(".file__content").cloneNode(!0);n.appendChild(d),d.classList.remove("visually-hidden"),d.classList.add("window__content"),d.classList.remove("file__content"),e.target.classList.contains("file--folder")&&d.classList.add("window__content--folder");const c=()=>{lastReference=r;const e=initialzIndex+1;n.style.zIndex=`${e}`,initialzIndex=e,r.classList.add("reference--active"),desktop.querySelectorAll(".window--active").forEach((e=>{e.classList.remove("window--active")})),n.classList.add("window--active"),desktop.querySelectorAll(".reference").forEach((e=>{e===lastReference?e.classList.add("reference--active"):e.classList.remove("reference--active")}))};c();const w=throttle((e=>{if(moveElement){e.stopPropagation();const t=isTouchDevice()?e.touches[0].clientX:e.clientX,i=isTouchDevice()?e.touches[0].clientY:e.clientY,o=initialX-t,l=initialY-i,s=n.offsetLeft-o+"px",r=n.offsetTop-l+"px";n.style.left=s,n.style.top=r,initialX=t,initialY=i}}),10),p=()=>{document.removeEventListener(events[deviceType].move,w),document.removeEventListener(events[deviceType].up,p),moveElement=!1},f=()=>{n.classList.contains("window--collapsed")?(n.classList.remove("window--collapsed"),c()):r===lastReference?n.classList.add("window--collapsed"):c()},u=e.target.querySelector(".file__icon").cloneNode(!0),h=r.querySelector(".reference__text");h.textContent=i.textContent,r.insertBefore(u,h),desktopFooter.appendChild(r),r.addEventListener(events[deviceType].click,f),n.addEventListener(events[deviceType].down,(e=>{e.target.closest(".window__draggable-area")&&(e=>{c(),e.stopPropagation(),e.cancelable&&e.preventDefault(),n.classList.contains("window--fullscreen")||(moveElement=!0,initialX=isTouchDevice()?e.touches[0].clientX:e.clientX,initialY=isTouchDevice()?e.touches[0].clientY:e.clientY,document.addEventListener(events[deviceType].move,w),document.addEventListener(events[deviceType].up,p))})(e),e.target.closest(".window__content")&&c()})),n.addEventListener(events[deviceType].click,(i=>{i.target.closest(".window__button--collapse")&&f(),i.target.closest(".window__button--close")&&(e.target.classList.add("file"),e.target.classList.remove("file--opened"),c(),n.remove(),r.remove(),t.classList.remove("file__label--active"),offsetVerticalCounter>0&&(offsetVerticalCounter-=1,initialWindowCounterVertical-=30),offsetHorisontalCounter>0&&(offsetHorisontalCounter-=1,initialWindowCounterHorisontal-=10)),i.target.closest(".window__button--expand")&&(c(),n.classList.contains("window--fullscreen")?n.classList.remove("window--fullscreen"):n.classList.add("window--fullscreen"))}))};desktopFooter.addEventListener("wheel",(e=>{e.preventDefault(),desktopFooter.scrollLeft+=e.deltaY})),desktop.addEventListener(events[deviceType].click,(e=>{e.target.closest(".file")&&!e.target.closest(".file--link")&&onFileOpen(e)}));